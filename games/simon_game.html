<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เกมกดตามม่อน - เกมของม่อน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #d1d5db; /* text-gray-300 */
        }
        .app-container {
            background-color: #1f2937; /* bg-gray-800 */
            box-shadow: 0 0 60px rgba(74, 222, 128, 0.1);
            border: 1px solid #374151;
        }
        .simon-game-board {
            position: relative;
            width: 320px;
            height: 320px;
            margin: 20px auto;
            border-radius: 50%;
            background-color: #111827;
            box-shadow: 0 0 20px rgba(0,0,0,0.5), inset 0 0 15px rgba(0,0,0,0.7);
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 10px;
        }
        .center-circle {
            position: absolute;
            width: 140px;
            height: 140px;
            background-color: #1f2937;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 10px solid #111827;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        .simon-btn {
            cursor: pointer;
            transition: background-color 0.2s, filter 0.2s, transform 0.1s;
            filter: brightness(0.5);
        }
        .simon-btn:active {
            transform: scale(0.98);
        }
        .simon-btn.lit {
            filter: brightness(1.2);
            box-shadow: 0 0 30px var(--glow-color);
        }
        #green { background-color: #10B981; border-top-left-radius: 100%; --glow-color: #6ee7b7; }
        #red { background-color: #EF4444; border-top-right-radius: 100%; --glow-color: #fca5a5; }
        #blue { background-color: #3B82F6; border-bottom-left-radius: 100%; --glow-color: #93c5fd; }
        #yellow { background-color: #F59E0B; border-bottom-right-radius: 100%; --glow-color: #fcd34d; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: #374151; color: white; padding: 2rem; border-radius: 1.5rem;
            text-align: center; width: 90%; max-width: 380px;
            transform: scale(0.9); transition: transform 0.3s ease;
            border: 1px solid #4b5563;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div id="app-container" class="app-container max-w-md mx-auto p-4 rounded-3xl">
        <div id="simon-game-screen">
            <header class="flex items-center justify-between mb-4">
                <a href="index.html" class="text-3xl text-emerald-400 hover:text-emerald-300 transition">&larr;</a>
                <h1 class="text-4xl font-bold text-emerald-400">เกมกดตามม่อน!</h1>
                <div></div>
            </header>

            <div class="simon-game-board">
                <div id="green" class="simon-btn" data-color="green"></div>
                <div id="red" class="simon-btn" data-color="red"></div>
                <div id="blue" class="simon-btn" data-color="blue"></div>
                <div id="yellow" class="simon-btn" data-color="yellow"></div>
                <div class="center-circle">
                    <div>
                        <p class="text-sm text-gray-400">LEVEL</p>
                        <p id="level-display" class="font-bold text-4xl text-white">0</p>
                    </div>
                     <div class="mt-2">
                        <p class="text-sm text-gray-400">SCORE</p>
                        <p id="score-display" class="font-bold text-lg text-emerald-400">0</p>
                    </div>
                </div>
            </div>

            <div class="text-center mt-6">
                <p id="message-display" class="text-xl h-8 font-semibold text-gray-300">กด "เริ่มเกม" เพื่อเริ่ม!</p>
                <button id="start-game-btn" class="mt-4 bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg text-xl border-b-4 border-emerald-700 transition disabled:bg-gray-500 disabled:border-gray-600 disabled:cursor-not-allowed">เริ่มเกม</button>
            </div>
        </div>
    </div>
    
    <div id="game-over-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title" class="text-3xl font-bold text-red-500 mb-2">เกมจบแล้ว!</h2>
            <p class="text-gray-400">คุณไปถึง <span id="final-level-text" class="font-bold"></span></p>
            <p class="text-white text-xl my-4">คะแนนรวม: <span id="final-score-text" class="font-bold text-2xl"></span></p>
            <div class="bg-gray-800 p-3 rounded-lg">
                <p class="text-emerald-400 text-lg">ได้รับ <span id="final-reward-text" class="font-bold text-2xl">0</span> เหรียญม่อน</p>
                <p id="bonus-game-text" class="text-green-400 font-bold hidden">(x2 จากเกมโบนัส!)</p>
            </div>
            <div class="flex gap-4 mt-6">
                <a href="index.html" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-xl shadow-md transition">กลับหน้าหลัก</a>
                <button id="play-again-btn" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-xl shadow-md transition">เล่นอีกครั้ง</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let state = {};
            // DOM Elements
            const buttons = {
                green: document.getElementById('green'),
                red: document.getElementById('red'),
                blue: document.getElementById('blue'),
                yellow: document.getElementById('yellow')
            };
            const startGameBtn = document.getElementById('start-game-btn');
            const levelDisplay = document.getElementById('level-display');
            const scoreDisplay = document.getElementById('score-display');
            const messageDisplay = document.getElementById('message-display');
            // Modal Elements
            const gameOverModal = document.getElementById('game-over-modal');
            const modalTitle = document.getElementById('modal-title');
            const finalLevelText = document.getElementById('final-level-text');
            const finalScoreText = document.getElementById('final-score-text');
            const finalRewardText = document.getElementById('final-reward-text');
            const bonusGameText = document.getElementById('bonus-game-text');
            const playAgainBtn = document.getElementById('play-again-btn');

            // Game State
            let sequence, playerSequence, level, score, canClick, turnTimeout;
            let isCurrentGameBonus = false;
            
            // Audio Hooks (หาไฟล์เสียง .mp3 มาใส่ในโฟลเดอร์)
            // const sounds = {
            //     green: new Audio('simon_green.mp3'),
            //     red: new Audio('simon_red.mp3'),
            //     blue: new Audio('simon_blue.mp3'),
            //     yellow: new Audio('simon_yellow.mp3'),
            //     error: new Audio('simon_error.mp3')
            // };

            function saveState() { localStorage.setItem('monGameDataV17', JSON.stringify(state)); }
            function loadState() {
                const savedData = localStorage.getItem('monGameDataV17');
                state = savedData ? JSON.parse(savedData) : { monCoins: 0, playCoins: 0 };
            }

            function startGame() {
                loadState();
                if (state.playCoins < 1) {
                    alert('เหรียญเล่นม่อนไม่พอ!');
                    return;
                }
                state.playCoins--;
                saveState();

                sequence = [];
                level = 0;
                score = 0;
                startGameBtn.disabled = true;
                scoreDisplay.textContent = 0;
                
                nextLevel();
            }

            function nextLevel() {
                level++;
                levelDisplay.textContent = level;
                playerSequence = [];
                canClick = false;
                messageDisplay.textContent = 'จำลำดับนะ...';
                
                const colors = Object.keys(buttons);
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                sequence.push(randomColor);
                
                playSequence();
            }

            async function playSequence() {
                await new Promise(resolve => setTimeout(resolve, 500)); // Pause before sequence starts
                for (const color of sequence) {
                    await lightUp(color);
                }
                startPlayerTurn();
            }

            function lightUp(color) {
                return new Promise(resolve => {
                    const button = buttons[color];
                    const duration = Math.max(100, 500 - (level * 20)); // Gets faster with levels
                    button.classList.add('lit');
                    // try { sounds[color].play(); } catch(e) {}
                    setTimeout(() => {
                        button.classList.remove('lit');
                        setTimeout(resolve, 100); // Pause between lights
                    }, duration);
                });
            }

            function startPlayerTurn() {
                canClick = true;
                const timeToRespond = Math.max(1000, 3000 - (level * 100));
                messageDisplay.textContent = 'ตาคุณแล้ว!';
                turnTimeout = setTimeout(() => {
                    endGame("หมดเวลา!", "คุณกดไม่ทันเวลา!");
                }, timeToRespond);
            }

            function handlePlayerClick(color) {
                if (!canClick) return;
                
                clearTimeout(turnTimeout);
                lightUp(color);
                playerSequence.push(color);
                const currentIndex = playerSequence.length - 1;

                if (playerSequence[currentIndex] !== sequence[currentIndex]) {
                    // try { sounds.error.play(); } catch(e) {}
                    endGame("เกมจบ!", "คุณกดผิดลำดับ!");
                    return;
                }
                
                // Add score based on how fast they press
                // This logic can be more complex, here's a simple version
                score += (10 + level); // Base score + level bonus
                scoreDisplay.textContent = score;

                if (playerSequence.length === sequence.length) {
                    canClick = false;
                    messageDisplay.textContent = 'ถูกต้อง!';
                    setTimeout(nextLevel, 1000);
                } else {
                    startPlayerTurn(); // Restart timer for next button press
                }
            }
            
            function endGame(title, reason) {
                canClick = false;
                clearTimeout(turnTimeout);
                startGameBtn.disabled = false;
                
                // NEW: Balanced reward formula
                let finalReward = Math.floor(level / 2) + Math.floor(score / 100);

                bonusGameText.classList.add('hidden');
                if (isCurrentGameBonus) {
                    finalReward *= 2;
                    bonusGameText.classList.remove('hidden');
                }

                if (finalReward > 0) {
                    state.monCoins += finalReward;
                    saveState();
                }
                
                modalTitle.textContent = title;
                finalLevelText.textContent = `ด่าน ${level}`;
                finalScoreText.textContent = score;
                finalRewardText.textContent = finalReward;
                messageDisplay.textContent = reason;
                gameOverModal.classList.add('visible');
            }

            // --- Initialization ---
            loadState();
            const urlParams = new URLSearchParams(window.location.search);
            isCurrentGameBonus = urlParams.get('bonus') === 'true';

            startGameBtn.addEventListener('click', startGame);
            playAgainBtn.addEventListener('click', () => {
                gameOverModal.classList.remove('visible');
                startGame();
            });
            Object.keys(buttons).forEach(color => {
                buttons[color].addEventListener('click', () => handlePlayerClick(color));
            });
        });
    </script>
</body>
</html>
