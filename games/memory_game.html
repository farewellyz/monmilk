<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏Å‡∏°‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏†‡∏≤‡∏û - ‡πÄ‡∏Å‡∏°‡∏Ç‡∏≠‡∏á‡∏°‡πà‡∏≠‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #fdf2f8; /* bg-pink-50 */
            background-image: radial-gradient(#fecdd3 1px, transparent 1px);
            background-size: 15px 15px;
            color: #4a5568; /* text-gray-700 */
        }
        .hidden {
            display: none;
        }
        .app-container {
            background-color: #fff0f5; /* Lavender Blush */
            box-shadow: 0 0 40px rgba(219, 39, 119, 0.15);
        }
        .card {
            @apply bg-white p-5 rounded-3xl shadow-lg transition-all duration-300;
        }

        /* === Memory Game Styles === */
        .memory-grid {
            /* Default for 4x4 (16 cards) */
            width: 408px;
            height: 408px;
            
            display: grid;
            grid-template-columns: repeat(4, 100px);
            grid-template-rows: repeat(4, 100px);
            gap: 0;
            margin: 0 auto;
        }

        /* New: CSS for 2x4 grid (8 cards) for easier levels */
        .memory-grid.small-grid {
            width: 204px; /* 2 * 100px (cards) + 2 * 2px (border) = 204px */
            height: 408px; /* 4 * 100px (cards) + 4 * 2px (border) = 408px */
            grid-template-columns: repeat(2, 100px); /* 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
            grid-template-rows: repeat(4, 100px);    /* 4 ‡πÅ‡∏ñ‡∏ß */
        }

        .memory-card {
            border: 2px solid black;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            aspect-ratio: 1 / 1;
            transform-style: preserve-3d;
            transition: transform 0.5s;
        }
        .memory-card.flipped {
            transform: rotateY(180deg);
        }
        .memory-card .front, .memory-card .back {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 6px;
            backface-visibility: hidden;
        }
        .memory-card .front {
            background-color: #d1d5db;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #6b7280;
            font-weight: bold;
            box-shadow: inset 0 0 0 4px rgba(255,255,255,0.5), inset 0 0 0 6px rgba(0,0,0,0.5);
        }
        .memory-card .back {
            transform: rotateY(180deg);
            background-color: #ffffff;
        }
        .memory-card .back img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }
        .memory-card.matched {
            transform: scale(0.95);
            opacity: 0.4;
            cursor: default;
        }
    </style>
</head>
<body>

    <div id="app-container" class="app-container max-w-md mx-auto min-h-screen p-4">
        <div id="memory-game-screen">
            <header class="flex items-center mb-2">
                <a href="index.html" class="text-3xl text-pink-500 hover:text-pink-600 transition">&larr;</a>
                <h1 class="text-2xl font-bold text-pink-500 ml-3">‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏†‡∏≤‡∏û!</h1>
            </header>
            <div class="card text-center mb-2 p-3">
                <p>Level: <span id="memory-level" class="font-bold text-2xl text-purple-500">1</span></p>
                <p id="memory-peek-timer" class="mt-1 text-lg h-6"></p>
            </div>
            <div id="memory-grid-container" class="bg-white rounded-3xl shadow-lg p-2">
                <div id="memory-grid" class="memory-grid">
                    </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT (Simplified for game file, relies on main state) ---
            let state = {};

            // --- DOM ELEMENTS ---
            const memoryLevelDisplay = document.getElementById('memory-level');
            const memoryPeekTimerDisplay = document.getElementById('memory-peek-timer');
            const memoryGrid = document.getElementById('memory-grid');

            // NEW: Variable to store if this is a bonus game, determined from URL
            let isCurrentGameBonus = false;

            // --- LOCAL STORAGE (Only for this game's state and global coins) ---
            function saveState() {
                localStorage.setItem('monGameDataV14', JSON.stringify(state));
            }

            function loadState() {
                try {
                    const savedData = localStorage.getItem('monGameDataV14');
                    if (savedData) {
                        state = JSON.parse(savedData);
                        // Ensure bonus game state properties exist, even if not in old saved data
                        if (typeof state.dailyBonusGameId === 'undefined') state.dailyBonusGameId = null;
                        if (typeof state.lastBonusGameDate === 'undefined') state.lastBonusGameDate = null;
                    } else {
                        // Default initial state if no data saved at all
                        state = { monCoins: 0, playCoins: 0, dailyBonusGameId: null, lastBonusGameDate: null }; 
                    }
                } catch (e) {
                    console.error("Error loading state from localStorage:", e);
                    // Fallback to default state if parsing fails
                    state = { monCoins: 0, playCoins: 0, dailyBonusGameId: null, lastBonusGameDate: null }; 
                }
            }

            // --- MEMORY GAME LOGIC ---
            const easyMemoryImages = [
                '1.jpg', 
                '2.jpg',
                '3.jpg',
                '4.jpg',
            ];

            const hardMemoryImages = [
                '1.jpg',
                '2.jpg',
                '3.jpg',
                '4.jpg',
                '5.jpg',
                '6.jpg',
                '7.jpg',
                '8.jpg',
            ];

            let memoryGameState = {};

            function initializeMemoryGame() {
                loadState(); // Load global state

                // NEW: Check URL parameter for bonus status (reliable method)
                const urlParams = new URLSearchParams(window.location.search);
                isCurrentGameBonus = urlParams.get('bonus') === 'true';

                if (state.playCoins > 0) {
                    state.playCoins -= 1;
                    saveState(); // Save updated playCoins
                    
                    memoryGameState = {
                        level: 1,
                        totalReward: 0,
                        cards: [],
                        flippedCards: [],
                        matchedPairs: 0,
                        canFlip: false,
                    };
                    startMemoryLevel();
                } else {
                    alert('‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÑ‡∏°‡πà‡∏û‡∏≠! ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ "‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÄ‡∏•‡πà‡∏ô‡∏°‡πà‡∏≠‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏ô‡∏∞');
                    window.location.href = 'index.html'; // Go back to main menu
                }
            }

            function startMemoryLevel() {
                memoryGameState.flippedCards = [];
                memoryGameState.matchedPairs = 0;
                memoryLevelDisplay.textContent = memoryGameState.level;
                
                const peekTimes = [5, 5, 10, 8, 6]; 
                const peekTime = memoryGameState.level > peekTimes.length ? 3 : peekTimes[memoryGameState.level - 1];

                createMemoryBoard(); 
                
                let countdown = peekTime;
                memoryPeekTimerDisplay.textContent = `‡∏à‡∏≥‡∏†‡∏≤‡∏û‡πÉ‡∏ô ${countdown} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ...`;
                const peekInterval = setInterval(() => {
                    countdown--;
                    memoryPeekTimerDisplay.textContent = `‡∏à‡∏≥‡∏†‡∏≤‡∏û‡πÉ‡∏ô ${countdown} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ...`;
                    if (countdown <= 0) {
                        clearInterval(peekInterval);
                        memoryPeekTimerDisplay.textContent = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏î‡πâ!';
                        memoryGameState.cards.forEach(card => card.classList.remove('flipped'));
                        memoryGameState.canFlip = true;
                    }
                }, 1000);
            }

            function createMemoryBoard() {
                let currentImages;
                let totalPairs;

                if (memoryGameState.level <= 2) { 
                    currentImages = [...easyMemoryImages];
                    totalPairs = easyMemoryImages.length;
                    memoryGrid.classList.add('small-grid'); 
                } else { 
                    currentImages = [...hardMemoryImages];
                    totalPairs = hardMemoryImages.length;
                    memoryGrid.classList.remove('small-grid'); 
                }

                const cardImages = [...currentImages, ...currentImages];
                cardImages.sort(() => 0.5 - Math.random());    

                memoryGrid.innerHTML = '';
                memoryGameState.cards = [];
                memoryGameState.totalPairs = totalPairs; 

                cardImages.forEach(imageSrc => {
                    const card = document.createElement('div');
                    card.className = 'memory-card flipped'; 
                    card.dataset.image = imageSrc;

                    card.innerHTML = `
                        <div class="front">?</div>
                        <div class="back"><img src="${imageSrc}" alt="card"></div>
                    `;
                    card.addEventListener('click', () => handleCardClick(card));
                    memoryGrid.appendChild(card);
                    memoryGameState.cards.push(card);
                });
            }

            function handleCardClick(clickedCard) {
                if (!memoryGameState.canFlip || clickedCard.classList.contains('flipped') || clickedCard.classList.contains('matched')) {
                    return;
                }

                clickedCard.classList.add('flipped');
                memoryGameState.flippedCards.push(clickedCard);

                if (memoryGameState.flippedCards.length === 2) {
                    memoryGameState.canFlip = false;
                    checkForMatch();
                }
            }

            function checkForMatch() {
                const [cardOne, cardTwo] = memoryGameState.flippedCards;
                if (cardOne.dataset.image === cardTwo.dataset.image) {
                    cardOne.classList.add('matched');
                    cardTwo.classList.add('matched');
                    memoryGameState.matchedPairs++;
                    memoryGameState.flippedCards = [];
                    setTimeout(() => { memoryGameState.canFlip = true; }, 300); 
                    
                    if (memoryGameState.matchedPairs === memoryGameState.totalPairs) { 
                        let reward = Math.pow(2, memoryGameState.level - 1);
                        
                        // --- NEW: Daily Bonus Game Check (Uses isCurrentGameBonus from URL) ---
                        let bonusGameMessagePart = ''; 
                        if (isCurrentGameBonus) { // Check the flag set at initialization
                            reward *= 2; // Multiply reward by 2
                            bonusGameMessagePart = " (x2 ‡πÄ‡∏Å‡∏°‡πÇ‡∏ö‡∏ô‡∏±‡∏™!)"; 
                        }
                        // --- END NEW ---

                        state.monCoins += reward;
                        memoryGameState.totalReward += reward; // Ensure totalReward also reflects bonus
                        saveState(); 

                        alert(`‡∏ú‡πà‡∏≤‡∏ô Level ${memoryGameState.level}! ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${reward} ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏°‡πà‡∏≠‡∏ô!${bonusGameMessagePart}`); // Add bonus message to alert
                        
                        memoryGameState.level++;
                        startMemoryLevel();
                    }
                } else {
                    setTimeout(() => {
                        cardOne.classList.remove('flipped');
                        cardTwo.classList.remove('flipped');
                        memoryGameState.flippedCards = [];
                        memoryGameState.canFlip = true;
                    }, 1000); 
                    setTimeout(() => {
                        // --- NEW: Daily Bonus Game Check (Uses isCurrentGameBonus from URL for message only) ---
                        let bonusGameMessagePart = '';
                        if (isCurrentGameBonus) { 
                            bonusGameMessagePart = "\nüéä ‡πÄ‡∏Å‡∏°‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô! ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• x2! üéä"; 
                        }
                        // --- END NEW ---
                        alert(`‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏ú‡∏¥‡∏î! ‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${memoryGameState.totalReward} ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏°‡πà‡∏≠‡∏ô!${bonusGameMessagePart}`); // Add bonus message to alert
                        window.location.href = 'index.html'; // Go back to main menu
                    }, 1200); 
                }
            }

            // --- INITIALIZATION ---
            initializeMemoryGame(); // Initialize the Memory game when this page loads
        });
    </script>
</body>
</html>