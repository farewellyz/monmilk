<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏Å‡∏°‡∏Ç‡∏≠‡∏á‡∏°‡πà‡∏≠‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #fdf2f8; /* bg-pink-50 */
            background-image: radial-gradient(#fecdd3 1px, transparent 1px);
            background-size: 15px 15px;
            color: #4a5568; /* text-gray-700 */
        }
        .hidden {
            display: none;
        }
        .app-container {
            background-color: #fff0f5; /* Lavender Blush */
            box-shadow: 0 0 40px rgba(219, 39, 119, 0.15);
        }
        
        .card-base {
            border: 2px solid #FBCFE8;
            background: linear-gradient(145deg, #fffafa, #ffe4e6);
            box-shadow: 0 5px 15px rgba(219, 39, 119, 0.1), inset 0 0 5px rgba(255,255,255,0.5);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-base:not(.bonus-game-card):hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(219, 39, 119, 0.15), inset 0 0 5px rgba(255,255,255,0.5);
        }

        .btn-base {
            transform: translateY(0);
            transition: transform 0.2s ease, filter 0.2s ease;
        }
        .btn-base:hover {
            transform: translateY(-2px);
            filter: brightness(1.05);
        }
        .btn-base:active {
            transform: translateY(1px);
        }
        
        @keyframes pulsing-glow {
            0%   { box-shadow: 0 0 15px rgba(255, 255, 255, 0.5), 0 0 25px rgba(255, 255, 255, 0.3); }
            50%  { box-shadow: 0 0 25px rgba(255, 255, 255, 0.9), 0 0 50px rgba(255, 255, 255, 0.6); }
            100% { box-shadow: 0 0 15px rgba(255, 255, 255, 0.5), 0 0 25px rgba(255, 255, 255, 0.3); }
        }

        @keyframes animated-rainbow-gradient {
            0%   { background-position: 0% 50%; }
            50%  { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .shaking {
            animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        #bonus-game-section {
            position: relative;
            border: 4px solid transparent;
            background-clip: padding-box; 
            overflow: hidden;
            border-radius: 1.5rem; 
        }

        #bonus-game-section::before {
            content: '';
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            z-index: 0;
            margin: -4px; 
            border-radius: inherit; 
            background: linear-gradient(125deg, #ff2400, #e81d1d, #e8b71d, #e3e81d, #1de840, #1ddde8, #2b1de8, #dd00f3, #dd00f3, #ff2400);
            background-size: 400% 400%;
            animation: animated-rainbow-gradient 10s infinite linear;
        }

        #bonus-game-section > * {
            position: relative;
            z-index: 1;
        }
        
        .bonus-game-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: #be185d;
            border-bottom: none;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.7);
        }

        .game-card.bonus-game {
            border: 3px solid #fff;
            transform: scale(1.05);
            background: linear-gradient(125deg, #ff2400, #e81d1d, #e8b71d, #e3e81d, #1de840, #1ddde8, #2b1de8, #dd00f3, #dd00f3, #ff2400);
            background-size: 400% 400%;
            animation: 
                pulsing-glow 2.5s infinite ease-in-out,
                animated-rainbow-gradient 10s infinite linear;
        }
        
        .game-card.bonus-game:hover {
            transform: translateY(-5px) scale(1.08);
            animation-play-state: paused;
        }
        
        .game-card.bonus-game h3, .game-card.bonus-game p {
            color: white;
            font-weight: 700;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8), 0 0 5px rgba(0, 0, 0, 0.8);
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            padding: 1.25rem;
            border-radius: 1.5rem;
            text-align: center;
            width: 90%;
            max-width: 380px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        /* Gacha Animation Styles */
        #gacha-animation-csgo {
            width: 100%;
            height: 120px;
            background-color: #e2e8f0;
            border-radius: 1rem;
            overflow: hidden;
            position: relative;
            border: 4px solid #cbd5e1;
        }
        #gacha-animation-csgo::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 100%;
            background-color: #ef4444;
            z-index: 2;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.7);
        }
        #gacha-reel {
            display: flex;
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
            transition: transform 5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .gacha-item {
            width: 120px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            padding: 0.5rem;
            border-right: 2px solid #cbd5e1;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .gacha-item-name {
            font-weight: 600;
            font-size: 0.9rem;
            text-align: center;
        }
        .rarity-common { background-color: #d1d5db; color: #1f2937; }
        .rarity-rare { background: linear-gradient(145deg, #60a5fa, #3b82f6); color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .rarity-epic { background: linear-gradient(145deg, #a855f7, #9333ea); color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .rarity-legendary { background: linear-gradient(145deg, #f59e0b, #d97706); color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }

        .winning-item {
            transform: scale(1.15);
            z-index: 10;
        }
        .rarity-rare.winning-item { box-shadow: 0 0 20px 5px #60a5fa; }
        .rarity-epic.winning-item { box-shadow: 0 0 20px 5px #a855f7; }
        .rarity-legendary.winning-item { box-shadow: 0 0 25px 8px #f59e0b; }
        
        @keyframes strong-shake { 0%, 100% {transform: translateX(0);} 10%, 30%, 50%, 70%, 90% {transform: translateX(-8px);} 20%, 40%, 60%, 80% {transform: translateX(8px);} }
        .shaking-box { animation: strong-shake 0.5s ease-in-out infinite; }
        
        @keyframes flash-rare { 0%, 100% { background-color: white; } 50% { background-color: #93c5fd; } }
        @keyframes flash-epic { 0%, 100% { background-color: white; } 50% { background-color: #c4b5fd; } }
        @keyframes flash-legendary { 0%, 100% { background-color: white; } 50% { background-color: #fcd34d; } }
        .flash-rare { animation: flash-rare 0.5s ease-out; }
        .flash-epic { animation: flash-epic 0.5s ease-out; }
        .flash-legendary { animation: flash-legendary 0.5s ease-out; }

        /* Pet Styles */
        .progress-bar-bg {
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
            height: 1.1rem;
        }
        .progress-bar {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
        #floating-pet-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
            cursor: grab;
        }
        #floating-pet-container:active {
            cursor: grabbing;
            transform: scale(1.1);
        }
        #floating-pet-image {
            width: 96px;
            height: 96px;
            -webkit-user-drag: none;
            user-select: none;
        }
        @keyframes pet-bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .pet-happy-animation { animation: pet-bounce 0.5s ease-in-out; }

        /* Speech Bubble Style */
        #pet-speech-bubble {
            position: absolute;
            bottom: 85px;
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            color: #4a5568;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            white-space: nowrap;
            z-index: 2;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        #pet-speech-bubble::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 6px;
            border-style: solid;
            border-color: white transparent transparent transparent;
        }
        
        /* Achievement Notification Badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 18px;
            height: 18px;
            background-color: #ef4444; /* red-500 */
            border-radius: 9999px;
            border: 2px solid white;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }
    </style>
</head>
<body>

    <div id="app-container" class="app-container max-w-md mx-auto min-h-screen p-4">

        <div id="menu-screen">
            <header class="text-center mb-6">
                <h1 class="text-5xl leading-tight font-bold bg-gradient-to-r from-fuchsia-500 to-pink-500 text-transparent bg-clip-text [text-shadow:1px_1px_3px_rgba(219,39,119,0.1)] mb-2">
                    ‡πÄ‡∏Å‡∏°‡∏Ç‡∏≠‡∏á‡∏°‡πà‡∏≠‡∏ô
                </h1>
                <p class="text-lg text-pink-500 font-medium mt-1">‡∏°‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞!</p>
            </header>

            <div id="exploration-status-card" class="card-base bg-white p-5 rounded-3xl shadow-lg mb-6 hidden">
                <h2 class="text-2xl font-semibold text-gray-600 mb-4 text-center pb-2 border-b border-dashed border-pink-200 flex items-center justify-center">
                    üß≠ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à
                </h2>
                <div class="text-center">
                    <p id="exploration-status-text" class="text-lg font-medium text-gray-700"></p>
                    <p class="text-3xl font-bold text-amber-500 my-2" id="exploration-timer">00:00:00</p>
                    <button id="claim-rewards-btn" class="btn-base w-full mt-2 px-4 py-3 text-lg font-bold text-white rounded-xl shadow-md flex items-center justify-center border-b-4 bg-gradient-to-br from-green-400 to-emerald-500 border-green-600 hidden">‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</button>
                </div>
            </div>

            <div id="bonus-game-section" class="card-base bg-white p-5 rounded-3xl shadow-lg mb-6 hidden">
                <h2 class="bonus-game-header text-2xl font-semibold mb-4 text-center pb-2 flex items-center justify-center">
                    <span class="w-8 h-8 mr-3 flex items-center justify-center text-2xl">‚ú®</span>
                    ‡πÄ‡∏Å‡∏°‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (x2 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç)
                </h2>
                <div class="text-center text-gray-700 font-semibold text-xl" id="daily-bonus-game-name"></div>
            </div>

            <div class="card-base bg-white p-5 rounded-3xl shadow-lg mb-6">
                <h2 class="text-2xl font-semibold text-gray-600 mb-4 text-center pb-2 border-b border-dashed border-pink-200 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 mr-3" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M17 8v-3a1 1 0 0 0 -1 -1h-10a2 2 0 0 0 0 4h12a1 1 0 0 1 1 1v3m0 4v3a1 1 0 0 1 -1 1h-12a2 2 0 0 1 -2 -2v-12" /><path d="M20 12v4h-4a2 2 0 0 1 0 -4h4" /></svg>
                    ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô
                </h2>
                <div class="flex justify-around items-center pt-2">
                    <div class="text-center">
                        <p class="text-4xl font-bold text-amber-500 flex items-center justify-center">
                            <span id="mon-coin-display">0</span>
                            <img src="mon_coin_icon.png" alt="Mon Coin" class="w-8 h-8 ml-2" onerror="this.style.display='none'">
                        </p>
                        <p class="text-sm font-medium text-gray-400">‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏°‡πà‡∏≠‡∏ô ($)</p>
                    </div>
                    <div class="text-center">
                        <p class="text-4xl font-bold text-emerald-500 flex items-center justify-center">
                            <span id="play-coin-display">0</span>
                            <img src="play_coin_icon.png" alt="Play Coin" class="w-8 h-8 ml-2" onerror="this.style.display='none'">
                        </p>
                        <p class="text-sm font-medium text-gray-400">‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÄ‡∏•‡πà‡∏ô‡∏°‡πà‡∏≠‡∏ô</p>
                    </div>
                </div>
            </div>

            <div id="inventory-card" class="card-base bg-white p-5 rounded-3xl shadow-lg mb-6 hidden">
                <h2 class="text-2xl font-semibold text-gray-600 mb-4 text-center pb-2 border-b border-dashed border-pink-200 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 mr-3" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 18h-2a2 2 0 0 1 -2 -2v-10a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-2" /><path d="M12 11v-6" /><path d="M8 7l4 -4l4 4" /><path d="M10 14h4" /></svg>
                    ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                </h2>
                <div id="inventory-list" class="space-y-2"></div>
            </div>

            <div class="card-base bg-white p-5 rounded-3xl shadow-lg mb-6">
                <h2 class="text-2xl font-semibold text-gray-600 mb-4 text-center pb-2 border-b border-dashed border-pink-200 flex items-center justify-center">
                   <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 mr-3" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M11.5 21h-5.5a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v6" /><path d="M16 3v4" /><path d="M8 3v4" /><path d="M4 11h16" /><path d="M19 16l-2 3h4l-2 3" /></svg>
                    ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
                </h2>
                <button id="check-in-btn" class="btn-base w-full px-4 py-3 text-lg font-bold text-white rounded-2xl shadow-md flex items-center justify-center border-b-4 bg-gradient-to-br from-sky-400 to-blue-500 border-sky-600 disabled:bg-gray-300 disabled:border-gray-400 disabled:cursor-not-allowed disabled:transform-none disabled:filter-grayscale">
                    ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô (‡∏£‡∏±‡∏ö 5 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç)
                </button>
            </div>
            
            <div class="card-base bg-white p-5 rounded-3xl shadow-lg mb-6">
                <h2 class="text-2xl font-semibold text-gray-600 mb-4 text-center pb-2 border-b border-dashed border-pink-200 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 mr-3" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" /><path d="M12 12m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" /><path d="M12 3l0 2" /><path d="M3 12l2 0" /><path d="M12 21l0 -2" /><path d="M21 12l-2 0" /></svg>
                    ‡∏Å‡∏≤‡∏ä‡∏≤‡∏õ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏°‡πà‡∏≠‡∏ô
                </h2>
                <button id="gacha-pull-btn" class="btn-base w-full px-4 py-3 text-lg font-bold text-white rounded-2xl shadow-md flex items-center justify-center border-b-4 bg-gradient-to-br from-purple-500 to-indigo-600 border-purple-800 mb-2">
                    ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏¢! (50 <img src="mon_coin_icon.png" class="w-5 h-5 ml-1 inline-block" onerror="this.style.display='none'">)
                </button>
                <button id="gacha-rates-btn" class="w-full text-sm text-pink-500 hover:text-pink-700 font-semibold">‡∏î‡∏π‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏£‡∏≠‡∏õ</button>
            </div>

            <div class="card-base bg-white p-5 rounded-3xl shadow-lg mb-6">
                <h2 class="text-2xl font-semibold text-gray-600 mb-4 text-center pb-2 border-b border-dashed border-pink-200 flex items-center justify-center">
                   <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 mr-3" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 5h-2a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-12a2 2 0 0 0 -2 -2h-2" /><path d="M9 3m0 2a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v0a2 2 0 0 1 -2 2h-2a2 2 0 0 1 -2 -2z" /><path d="M18 22l3.35 -3.284a2.143 2.143 0 0 0 .005 -3.071a2.242 2.242 0 0 0 -3.129 -.006l-.224 .22l-.223 -.22a2.242 2.242 0 0 0 -3.128 -.006a2.143 2.143 0 0 0 -.006 3.071l3.355 3.296z" /></svg>
                    ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
                </h2>
                <div id="daily-missions-list" class="space-y-3"></div>
            </div>

            <div class="game-buttons-section mb-6">
                <h2 class="text-2xl font-semibold text-gray-600 mb-4 text-center pb-2 border-b border-dashed border-pink-200 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 mr-3" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M2 12c0 -2.76 2.24 -5 5 -5h10c2.76 0 5 2.24 5 5v7h-20v-7z" /><path d="M5.5 12h.01" /><path d="M8.5 12h.01" /><path d="M15.5 12h.01" /><path d="M18.5 12h.01" /><path d="M15 5v-1a2 2 0 0 0 -2 -2h-2a2 2 0 0 0 -2 2v1" /></svg>
                    ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏Å‡∏±‡∏ô!
                </h2>
                <div id="game-card-container" class="grid gap-4" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
                    <a href="./rps_game.html" class="game-card block p-4 rounded-2xl shadow-md text-center transition-all duration-300 border-b-4 relative overflow-hidden bg-gradient-to-br from-pink-400 to-red-400 border-pink-600 hover:transform hover:-translate-y-1" data-game-id="rps">
                        <h3 class="text-white text-xl font-bold mb-1 relative z-10 [text-shadow:1px_1px_2px_rgba(0,0,0,0.3)]">‡πÄ‡∏õ‡πà‡∏≤‡∏¢‡∏¥‡πâ‡∏á‡∏â‡∏∏‡∏ö</h3>
                        <p class="text-white text-sm opacity-90 relative z-10">‡πÉ‡∏ä‡πâ 1 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</p>
                    </a>
                    <a href="./memory_game.html" class="game-card block p-4 rounded-2xl shadow-md text-center transition-all duration-300 border-b-4 relative overflow-hidden bg-gradient-to-br from-sky-400 to-indigo-500 border-sky-600 hover:transform hover:-translate-y-1" data-game-id="memory">
                        <h3 class="text-white text-xl font-bold mb-1 relative z-10 [text-shadow:1px_1px_2px_rgba(0,0,0,0.3)]">‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏†‡∏≤‡∏û</h3>
                        <p class="text-white text-sm opacity-90 relative z-10">‡πÉ‡∏ä‡πâ 1 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</p>
                    </a>
                    <a href="./simon_game.html" class="game-card block p-4 rounded-2xl shadow-md text-center transition-all duration-300 border-b-4 relative overflow-hidden bg-gradient-to-br from-purple-400 to-fuchsia-500 border-purple-600 hover:transform hover:-translate-y-1" data-game-id="simon">
                        <h3 class="text-white text-xl font-bold mb-1 relative z-10 [text-shadow:1px_1px_2px_rgba(0,0,0,0.3)]">‡πÄ‡∏Å‡∏°‡∏Å‡∏î‡∏ï‡∏≤‡∏°‡∏°‡πà‡∏≠‡∏ô</h3>
                        <p class="text-white text-sm opacity-90 relative z-10">‡πÉ‡∏ä‡πâ 1 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</p>
                    </a>
                    <a href="./whac_a_mole_game.html" class="game-card block p-4 rounded-2xl shadow-md text-center transition-all duration-300 border-b-4 relative overflow-hidden bg-gradient-to-br from-indigo-500 to-purple-800 border-indigo-800 hover:transform hover:-translate-y-1" data-game-id="whac_a_mole">
                        <h3 class="text-white text-xl font-bold mb-1 relative z-10 [text-shadow:1px_1px_2px_rgba(0,0,0,0.3)]">‡πÄ‡∏Å‡∏°‡∏ï‡∏µ‡∏´‡∏±‡∏ß‡∏°‡πà‡∏≠‡∏ô</h3>
                        <p class="text-white text-sm opacity-90 relative z-10">‡πÉ‡∏ä‡πâ 1 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</p>
                    </a>
                    <a href="./catch_falling_object.html" class="game-card block p-4 rounded-2xl shadow-md text-center transition-all duration-300 border-b-4 relative overflow-hidden bg-gradient-to-br from-rose-400 to-pink-500 border-rose-600 hover:transform hover:-translate-y-1" data-game-id="catch_object">
                        <h3 class="text-white text-xl font-bold mb-1 relative z-10 [text-shadow:1px_1px_2px_rgba(0,0,0,0.3)]">‡πÄ‡∏Å‡∏°‡∏£‡∏±‡∏ö‡∏°‡πà‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢</h3>
                        <p class="text-white text-sm opacity-90 relative z-10">‡πÉ‡∏ä‡πâ 1 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</p>
                    </a>
                    <a href="./cafe.html" class="game-card block p-4 rounded-2xl shadow-md text-center transition-all duration-300 border-b-4 relative overflow-hidden bg-gradient-to-br from-amber-400 to-yellow-600 border-amber-600 hover:transform hover:-translate-y-1" data-game-id="cafe">
                        <h3 class="text-white text-xl font-bold mb-1 relative z-10 [text-shadow:1px_1px_2px_rgba(0,0,0,0.3)]">‡πÄ‡∏Å‡∏°‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà</h3>
                        <p class="text-white text-sm opacity-90 relative z-10">‡πÉ‡∏ä‡πâ 1 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</p>
                    </a>
                </div>
            </div>

            <div class="game-buttons-section"> 
                <h2 class="text-2xl font-semibold text-gray-600 mb-4 text-center pb-2 border-b border-dashed border-pink-200 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 mr-3" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6.331 8h11.339a2 2 0 0 1 1.977 2.304l-1.255 8.152a3 3 0 0 1 -2.966 2.544h-6.852a3 3 0 0 1 -2.965 -2.544l-1.255 -8.152a2 2 0 0 1 1.977 -2.304z" /><path d="M9 11v-5a3 3 0 0 1 6 0v5" /></svg>
                    ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏°‡πà‡∏≠‡∏ô
                </h2>
                <button id="go-to-shop-btn" class="btn-base w-full px-4 py-3 text-lg font-bold text-white rounded-2xl shadow-md flex items-center justify-center border-b-4 bg-gradient-to-br from-amber-400 to-orange-500 border-amber-600">
                    ‡πÑ‡∏õ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á
                </button>
            </div>
        </div>

        <div id="shop-screen" class="hidden">
            <header class="flex items-center mb-6">
                <button id="shop-back-btn" class="text-3xl text-pink-500 hover:text-pink-600 transition">&larr;</button>
                <h1 class="text-3xl sm:text-4xl font-bold text-pink-500 ml-4">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏°‡πà‡∏≠‡∏ô</h1>
            </header>
            <div id="shop-items-list" class="space-y-4"></div>
        </div>
    </div>

    <div id="floating-pet-container" class="hidden">
        <div id="pet-speech-bubble" class="hidden"></div>
        <img id="floating-pet-image" src="" alt="‡∏ô‡πâ‡∏≠‡∏á‡∏°‡πà‡∏≠‡∏ô">
    </div>

    <div id="pet-stats-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="pet-section">
                <div id="pet-display-area" class="relative bg-cover bg-center rounded-xl p-3 mb-3 transition-all duration-500" style="box-shadow: inset 0 0 30px rgba(0,0,0,0.1);">
                    <div class="flex items-center mb-2">
                        <h2 id="pet-name" class="text-xl font-bold text-white" style="text-shadow: 1px 1px 4px rgba(0,0,0,0.7);"></h2>
                        <span id="pet-level" class="ml-2 text-xs font-bold bg-black/30 text-white px-2 py-0.5 rounded-full"></span>
                    </div>
                    <div class="text-center">
                        <img id="pet-modal-image" src="" alt="‡∏ô‡πâ‡∏≠‡∏á‡∏°‡πà‡∏≠‡∏ô" class="h-28 mx-auto drop-shadow-lg">
                    </div>
                </div>

                <div id="pet-background-buff-display" class="text-center bg-pink-100 text-pink-700 font-semibold p-2 rounded-lg my-2 border border-pink-200 hidden text-sm">
                </div>

                <div id="pet-exploration-status-in-modal" class="hidden text-center mb-3 p-2 bg-yellow-100 border-l-4 border-yellow-400 rounded-lg">
                    <p class="font-semibold text-yellow-800 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ó‡∏µ‡πà <span id="pet-exploration-location-in-modal"></span></p>
                    <p class="text-md font-bold text-yellow-600" id="pet-exploration-timer-in-modal">00:00:00</p>
                </div>

                <div class="space-y-2">
                    <div>
                        <div class="flex justify-between text-xs font-semibold text-gray-500 mb-1">
                            <span>EXP</span>
                            <span id="pet-exp-text">0/100</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div id="pet-exp-bar" class="progress-bar bg-gradient-to-r from-yellow-300 to-amber-400" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs font-semibold text-gray-500 mb-1">
                            <span>‚ù§Ô∏è ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏¥‡πà‡∏°</span>
                            <span id="pet-hunger-text">0/100</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div id="pet-hunger-bar" class="progress-bar bg-gradient-to-r from-red-400 to-rose-500" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs font-semibold text-gray-500 mb-1">
                            <span>üòä ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç</span>
                            <span id="pet-happiness-text">0/100</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div id="pet-happiness-bar" class="progress-bar bg-gradient-to-r from-sky-400 to-cyan-400" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs font-semibold text-gray-500 mb-1">
                            <span>‚ö°Ô∏è ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô</span>
                            <span id="pet-stamina-text">0/100</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div id="pet-stamina-bar" class="progress-bar bg-gradient-to-r from-lime-400 to-green-500" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
                <div id="pet-action-buttons" class="grid grid-cols-2 gap-2 mt-3">
                    <button id="feed-pet-btn" class="btn-base w-full px-4 py-2 text-sm font-bold text-white rounded-xl shadow-md flex items-center justify-center border-b-4 bg-gradient-to-br from-green-400 to-emerald-500 border-green-600">‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
                    <button id="play-with-pet-btn" class="btn-base w-full px-4 py-2 text-sm font-bold text-white rounded-xl shadow-md flex items-center justify-center border-b-4 bg-gradient-to-br from-blue-400 to-indigo-500 border-blue-600">‡πÄ‡∏•‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢</button>
                    <a href="exploration.html" class="btn-base w-full px-4 py-2 text-sm font-bold text-white rounded-xl shadow-md flex items-center justify-center border-b-4 bg-gradient-to-br from-yellow-400 to-orange-500 border-yellow-600">‡∏≠‡∏≠‡∏Å‡∏™‡∏≥‡∏£‡∏ß‡∏à</a>
                    <a href="garden.html" class="btn-base w-full px-4 py-2 text-sm font-bold text-white rounded-xl shadow-md flex items-center justify-center border-b-4 bg-gradient-to-br from-lime-500 to-green-600 border-lime-700">‡πÅ‡∏õ‡∏•‡∏á‡∏ú‡∏±‡∏Å</a>
                </div>
                
                <div class="grid grid-cols-2 gap-2 mt-3">
                     <button id="change-bg-btn" class="btn-base w-full px-2 py-2 text-sm font-bold text-white rounded-xl shadow-md flex items-center justify-center border-b-4 bg-gradient-to-br from-purple-400 to-fuchsia-500 border-purple-600">
                        ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
                    </button>
                     <button id="upgrade-pet-btn" class="btn-base w-full px-2 py-2 text-sm font-bold text-white rounded-xl shadow-md flex items-center justify-center border-b-4 bg-gradient-to-br from-orange-400 to-red-500 border-orange-600">
                        ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î
                    </button>
                </div>
                
                <div class="grid grid-cols-2 gap-2 mt-3">
                    <button id="use-item-btn" class="btn-base w-full px-2 py-2 text-sm font-bold text-white rounded-xl shadow-md flex items-center justify-center border-b-4 bg-gradient-to-br from-teal-400 to-cyan-500 border-teal-600">
                        ‡πÉ‡∏ä‡πâ‡πÑ‡∏≠‡πÄ‡∏ó‡∏°
                    </button>
                    <button id="achievements-btn" class="btn-base relative w-full px-2 py-2 text-sm font-bold text-white rounded-xl shadow-md flex items-center justify-center border-b-4 bg-gradient-to-br from-amber-400 to-yellow-500 border-amber-600">
                        ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                        <span id="achievement-notification" class="notification-badge hidden"></span>
                    </button>
                </div>

                <button id="close-pet-stats-modal-btn" class="btn-base w-full mt-3 px-4 py-2 text-md font-semibold text-gray-700 bg-gray-200 rounded-xl">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>
    
    <div id="background-modal" class="modal-overlay">
        <div class="modal-content">
             <h2 class="text-2xl font-bold text-pink-500 mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á</h2>
             <div id="pet-background-list" class="grid grid-cols-3 gap-2 max-h-64 overflow-y-auto p-2 bg-gray-100 rounded-lg">
             </div>
             <button id="close-background-modal-btn" class="btn-base w-full mt-4 px-4 py-2 text-md font-semibold text-gray-700 bg-gray-200 rounded-xl">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <div id="use-item-modal" class="modal-overlay">
        <div class="modal-content">
             <h2 class="text-2xl font-bold text-pink-500 mb-4">‡πÉ‡∏ä‡πâ‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π</h2>
             <div id="item-use-list" class="space-y-3">
             </div>
             <button id="close-use-item-modal-btn" class="btn-base w-full mt-4 px-4 py-2 text-md font-semibold text-gray-700 bg-gray-200 rounded-xl">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <div id="upgrade-modal" class="modal-overlay">
        <div class="modal-content">
             <h2 class="text-2xl font-bold text-pink-500 mb-4">‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏ö‡πâ‡∏≤‡∏ô</h2>
             <div id="upgrade-list" class="space-y-4 text-left">
             </div>
             <button id="close-upgrade-modal-btn" class="btn-base w-full mt-6 px-4 py-2 text-md font-semibold text-gray-700 bg-gray-200 rounded-xl">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <div id="achievements-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 420px;">
            <h2 class="text-2xl font-bold text-pink-500 mb-4">üèÜ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h2>
            <div id="achievements-content" class="text-left space-y-4 max-h-[70vh] overflow-y-auto p-2 bg-gray-50 rounded-lg">
                <!-- Achievements will be rendered here -->
            </div>
            <button id="close-achievements-modal-btn" class="btn-base w-full mt-4 px-4 py-2 text-md font-semibold text-gray-700 bg-gray-200 rounded-xl">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>


    <div id="hatch-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="egg-stage">
                <h2 class="text-2xl font-bold text-pink-500 mb-2">‡∏≠‡∏∏‡πä‡∏¢! ‡πÄ‡∏à‡∏≠‡πÑ‡∏Ç‡πà‡∏õ‡∏£‡∏¥‡∏®‡∏ô‡∏≤</h2>
                <p class="text-gray-600 mb-4">‡∏°‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏Ç‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏Å‡∏ô‡πâ‡∏≠‡∏á‡∏°‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏ô‡∏∞!</p>
                <img id="egg-image" src="egg.png" alt="Egg" class="mx-auto cursor-pointer h-32 w-32">
                <p class="mt-2 text-gray-500"><span id="egg-taps">0</span> / 20</p>
            </div>
            <div id="name-stage" class="hidden">
                <h2 class="text-2xl font-bold text-pink-500 mb-4">‡∏ô‡πâ‡∏≠‡∏á‡∏°‡πà‡∏≠‡∏ô‡∏ü‡∏±‡∏Å‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß!</h2>
                <img src="https://placehold.co/128x128/fbcfe8/be185d?text=ü•∞" alt="Baby Mon" class="mx-auto h-32 w-32 mb-4">
                <p class="text-gray-600 mb-4">‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≠‡∏á‡∏°‡πà‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞:</p>
                <input type="text" id="pet-name-input" class="w-full p-2 border-2 border-pink-200 rounded-lg text-center" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡πâ‡∏≠‡∏á‡∏°‡πà‡∏≠‡∏ô" maxlength="12">
                <button id="confirm-name-btn" class="btn-base w-full mt-4 px-4 py-3 text-lg font-bold text-white rounded-2xl shadow-md bg-gradient-to-br from-pink-500 to-rose-500 border-rose-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>

    <div id="feed-modal" class="modal-overlay">
        <div class="modal-content">
             <h2 class="text-2xl font-bold text-pink-500 mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≠‡∏á‡∏°‡πà‡∏≠‡∏ô</h2>
             <div id="food-list" class="space-y-3"></div>
             <button id="close-feed-modal-btn" class="btn-base w-full mt-4 px-4 py-2 text-md font-semibold text-gray-700 bg-gray-200 rounded-xl">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <div id="play-modal" class="modal-overlay">
        <div class="modal-content">
             <h2 class="text-2xl font-bold text-pink-500 mb-4">‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ö‡∏ô‡πâ‡∏≠‡∏á‡∏°‡πà‡∏≠‡∏ô</h2>
             <div id="play-options-list" class="space-y-3"></div>
             <button id="close-play-modal-btn" class="btn-base w-full mt-4 px-4 py-2 text-md font-semibold text-gray-700 bg-gray-200 rounded-xl">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <div id="gacha-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="gacha-title" class="text-3xl font-bold text-pink-500 mb-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏∏‡πà‡∏°...</h2>
            <div id="gacha-animation-csgo" class="mb-4">
                <div id="gacha-reel"></div>
            </div>
            <div id="gacha-result" class="hidden">
                <p class="text-lg text-gray-600 mb-2">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:</p>
                <p id="gacha-prize-text" class="text-2xl font-bold text-purple-600 mb-6"></p>
            </div>
            <button id="close-gacha-modal-btn" class="btn-base w-full px-4 py-3 text-lg font-bold text-white rounded-2xl shadow-md bg-gradient-to-br from-pink-500 to-rose-500 border-rose-700 hidden">
                ‡∏õ‡∏¥‡∏î
            </button>
        </div>
    </div>
    
    <div id="gacha-rates-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-3xl font-bold text-pink-500 mb-4">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏£‡∏≠‡∏õ‡∏Å‡∏≤‡∏ä‡∏≤</h2>
            <div id="gacha-rates-list" class="text-left space-y-2 max-h-64 overflow-y-auto"></div>
            <button id="close-gacha-rates-modal-btn" class="btn-base w-full px-4 py-3 text-lg font-bold text-white rounded-2xl shadow-md bg-gradient-to-br from-pink-500 to-rose-500 border-rose-700 mt-6">
                ‡∏õ‡∏¥‡∏î
            </button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // This is a simplified game state management. 
            // In a real application, you might use a more robust solution.
            let state = {};
            let explorationInterval = null;

            // All static definitions for the game are here.
            const allMissions = [
                { text: '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏°‡πà‡∏≠‡∏ô (1 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç)', reward: 1 }, 
                { text: '‡∏ñ‡πà‡∏≤‡∏¢ ootd ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏°‡πà‡∏≠‡∏ô (1 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç)', reward: 1 },
                { text: '‡∏ö‡∏≠‡∏Å‡∏£‡∏±‡∏Å‡∏°‡πà‡∏≠‡∏ô (1 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç)', reward: 1 }, 
                { text: '‡∏ö‡∏≠‡∏Å‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á‡∏°‡πà‡∏≠‡∏ô (1 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç)', reward: 1 },
                { text: '‡∏≠‡∏±‡∏î‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ö‡∏≠‡∏Å‡∏£‡∏±‡∏Å‡∏°‡πà‡∏≠‡∏ô (1 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç)', reward: 1 }, 
                { text: '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏™‡πà‡∏á‡∏à‡∏∏‡πâ‡∏ö‡πÉ‡∏´‡πâ‡∏°‡πà‡∏≠‡∏ô (1 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç)', reward: 1 },
                { text: '‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏á‡πÉ‡∏´‡πâ‡∏°‡πà‡∏≠‡∏ô‡∏ü‡∏±‡∏á (1 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç)', reward: 1 }, 
                { text: '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏°‡πà‡∏≠‡∏ô (1 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç)', reward: 1 },
                { text: '‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏°‡πà‡∏≠‡∏ô‡∏ö‡∏≠‡∏Å‡∏£‡∏±‡∏Å (1 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç)', reward: 1 }, 
                { text: '‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏°‡πà‡∏≠‡∏ô‡∏ö‡∏≠‡∏Å‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á (1 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç)', reward: 1 },
				{ text: '‡πÇ‡∏ä‡∏ß‡πå‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß‡πÉ‡∏´‡πâ‡∏°‡πà‡∏≠‡∏ô‡∏î‡∏π (1 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç)', reward: 1 }, 
                { text: '‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ö‡πä‡∏ß (1 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç)', reward: 1 },
                { text: '‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏°‡πà‡∏≠‡∏ô‡∏¢‡∏¥‡πâ‡∏° (1 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç)', reward: 1 }, 
                { text: '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ï‡∏≠‡∏ô‡∏ó‡∏≤‡∏Ñ‡∏£‡∏µ‡∏° (1 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç)', reward: 1 },
				{ text: '‡∏ö‡∏≠‡∏Å‡∏£‡∏±‡∏Å‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤‡∏£‡∏±‡∏Å (1 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç)', reward: 1 }, 
                { text: '‡∏•‡∏á‡∏™‡∏ï‡∏≠‡∏£‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏°‡πà‡∏≠‡∏ô (2 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç)', reward: 2 },
            ];
            
            const shopItemDefinitions = [
                { id: 'ticket_random', name: '‡∏ï‡∏±‡πã‡∏ß‡∏™‡∏∏‡πà‡∏°‡∏ß‡∏á‡∏•‡πâ‡∏≠', basePrice: 200, type: 'ticket', category: '‡∏ï‡∏±‡πã‡∏ß‡∏û‡∏¥‡πÄ‡∏®‡∏©' },  
                { id: 'ticket_trip', name: '‡∏ï‡∏±‡πã‡∏ß‡πÉ‡∏´‡πâ‡∏û‡∏≤‡πÑ‡∏õ‡πÑ‡∏´‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ', basePrice: 600, type: 'ticket', category: '‡∏ï‡∏±‡πã‡∏ß‡∏û‡∏¥‡πÄ‡∏®‡∏©' }, 
                { id: 'ticket_wish', name: '‡∏ï‡∏±‡πã‡∏ß‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ', basePrice: 2000, type: 'ticket', category: '‡∏ï‡∏±‡πã‡∏ß‡∏û‡∏¥‡πÄ‡∏®‡∏©' }, 
                { id: 'ticket_command', name: '‡∏ï‡∏±‡πã‡∏ß‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡πâ‡∏≤‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ', basePrice: 1000, type: 'ticket', category: '‡∏ï‡∏±‡πã‡∏ß‡∏û‡∏¥‡πÄ‡∏®‡∏©' },
                { id: 'item_m150', name: 'M150', basePrice: 60, type: 'consumable', category: '‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π' },
                { id: 'item_latte', name: '‡∏•‡∏≤‡πÄ‡∏ï‡πâ', basePrice: 90, type: 'consumable', category: '‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π' },
                { id: 'item_americano', name: '‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤‡πÇ‡∏ô‡πà', basePrice: 150, type: 'consumable', category: '‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π' },
                { id: 'kitchen', name: '‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á: ‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ß', basePrice: 200, type: 'background', category: '‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á' },
                { id: 'library', name: '‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á: ‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î', basePrice: 200, type: 'background', category: '‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á' },
            ];
            
            const consumableItems = {
                'ticket_random': { name: '‡∏ï‡∏±‡πã‡∏ß‡∏™‡∏∏‡πà‡∏°‡∏ß‡∏á‡∏•‡πâ‡∏≠' },
                'ticket_trip': { name: '‡∏ï‡∏±‡πã‡∏ß‡πÉ‡∏´‡πâ‡∏û‡∏≤‡πÑ‡∏õ‡πÑ‡∏´‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ' },
                'ticket_wish': { name: '‡∏ï‡∏±‡πã‡∏ß‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ' },
                'ticket_command': { name: '‡∏ï‡∏±‡πã‡∏ß‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡πâ‡∏≤‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ' },
                'item_m150': { name: 'M150' },
                'item_latte': { name: '‡∏•‡∏≤‡πÄ‡∏ï‡πâ' },
                'item_americano': { name: '‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤‡πÇ‡∏ô‡πà' },
                '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á': { name: '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á' },
                '‡πÄ‡∏Ñ‡πâ‡∏Å': { name: '‡πÄ‡∏Ñ‡πâ‡∏Å' },
                '‡πÑ‡∏≠‡∏®‡∏Å‡∏£‡∏µ‡∏°': { name: '‡πÑ‡∏≠‡∏®‡∏Å‡∏£‡∏µ‡∏°' },
                '‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏¢‡∏≤‡∏á': { name: '‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏¢‡∏≤‡∏á' },
                '‡∏•‡∏π‡∏Å‡∏ö‡∏≠‡∏•': { name: '‡∏•‡∏π‡∏Å‡∏ö‡∏≠‡∏•' },
                '‡∏Å‡∏µ‡∏ï‡πâ‡∏≤': { name: '‡∏Å‡∏µ‡∏ï‡πâ‡∏≤' },
                '‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå': { name: '‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå' },
                '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®' },
                '‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®': { name: '‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®' },
                '‡πÄ‡∏°‡∏•‡πá‡∏î‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó' },
                '‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó': { name: '‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó' },
                '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏ö‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏•‡∏µ': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏ö‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏•‡∏µ' },
                '‡∏ö‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏•‡∏µ': { name: '‡∏ö‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏•‡∏µ' },
                '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ' },
                '‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ': { name: '‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ' },
            };

            const petBackgroundDefinitions = {
                // Original Backgrounds
                'default': { name: '‡∏´‡πâ‡∏≠‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤', description: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏û‡∏¥‡πÄ‡∏®‡∏©', image: `room.jpg` },
                'kitchen': { name: '‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ß', description: '‡∏´‡∏¥‡∏ß‡∏ä‡πâ‡∏≤‡∏•‡∏á 10%', image: `kitchen.jpg` },
                'library': { name: '‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î', description: '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö EXP ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 10%', image: `library.jpg` },
                'beach': { name: '‡∏ä‡∏≤‡∏¢‡∏´‡∏≤‡∏î', description: '‡πÉ‡∏ä‡πâ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á 10%', image: `beach.jpg` },
                'bedroom': { name: '‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô', description: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏•‡∏î‡∏ä‡πâ‡∏≤‡∏•‡∏á 10%', image: `bedroom.jpg` },
                'restaurant': { name: '‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', description: '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏•‡∏î‡∏•‡∏á 20%', image: `restaurant.jpg` },
                'amusement_park': { name: '‡∏™‡∏ß‡∏ô‡∏™‡∏ô‡∏∏‡∏Å', description: '‡πÄ‡∏•‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏° 20%', image: `amusement_park.jpg` },
                'vegetable_garden': { name: '‡∏™‡∏ß‡∏ô‡∏ú‡∏±‡∏Å', description: '‡∏ú‡∏±‡∏Å‡πÇ‡∏ï‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô 10%', image: `vegetable_garden.jpg` },
                'forest': { name: '‡∏õ‡πà‡∏≤', description: '‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏î‡∏£‡∏≠‡∏õ‡∏Ç‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° 5%', image: `forest.jpg` },
                // New Achievement Unlocks (You can add image paths here later)
                'mythical_garden': { name: '‡∏™‡∏ß‡∏ô‡πÄ‡∏ó‡∏û‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢', description: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡πÉ‡∏´‡πâ EXP +10%', image: 'https://placehold.co/400x200/dcfce7/166534?text=Mythical+Garden' },
                'crystal_chamber': { name: '‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏±‡∏•', description: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏Ñ‡πâ‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç +15%', image: 'https://placehold.co/400x200/f0f9ff/075985?text=Crystal+Chamber' },
                'sky_palace': { name: '‡∏ß‡∏±‡∏á‡∏ü‡πâ‡∏≤', description: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏≠‡∏®‡∏Å‡∏£‡∏µ‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏°‡πà‡∏≠‡∏ô +5%', image: 'https://placehold.co/400x200/e0f2fe/0c4a6e?text=Sky+Palace' },
                'magical_aquarium': { name: '‡∏≠‡∏Ñ‡∏ß‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå', description: '‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Ñ‡∏∑‡∏ô', image: 'https://placehold.co/400x200/ecfeff/0e7490?text=Aquarium' },
                'playroom': { name: 'Playroom', description: '‡πÑ‡∏î‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô +20%', image: 'https://placehold.co/400x200/fef2f2/991b1b?text=Playroom' },
                'playground': { name: '‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏•‡πà‡∏ô', description: '‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏•‡∏î‡∏ä‡πâ‡∏≤‡∏•‡∏á 10%', image: 'https://placehold.co/400x200/f0fdf4/166534?text=Playground' },
                'music_room': { name: '‡∏´‡πâ‡∏≠‡∏á‡∏î‡∏ô‡∏ï‡∏£‡∏µ', description: 'EXP ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ +15%', image: 'https://placehold.co/400x200/f5f3ff/5b21b6?text=Music+Room' },
                'digital_nexus': { name: 'Digital Nexus', description: '‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏ä‡πâ -30% ‡πÅ‡∏•‡∏∞ EXP +15%', image: 'https://placehold.co/400x200/f3f4f6/111827?text=Digital+Nexus' },
                'gym_room': { name: '‡∏´‡πâ‡∏≠‡∏á‡∏Å‡∏µ‡∏¨‡∏≤', description: '‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π Stamina +20%', image: 'https://placehold.co/400x200/fafafa/171717?text=Gym' },
                'cute_cafe': { name: '‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å', description: '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç +10%', image: 'https://placehold.co/400x200/fdf4ff/a21caf?text=Cafe' },
                'coffee_lounge': { name: 'Coffee Lounge', description: 'EXP +10%, ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏¥‡∏ß‡∏•‡∏î‡∏ä‡πâ‡∏≤‡∏•‡∏á 10%', image: 'https://placehold.co/400x200/fdf2f8/9d174d?text=Lounge' },
                'secret_garden': { name: '‡∏™‡∏ß‡∏ô‡∏•‡∏±‡∏ö', description: '‡∏î‡∏£‡∏≠‡∏õ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à +5%', image: 'https://placehold.co/400x200/f0fdfa/0f766e?text=Secret+Garden' },
                'hidden_shop': { name: '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡∏±‡∏ö', description: '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡∏î 10%', image: 'https://placehold.co/400x200/fefce8/a16207?text=Hidden+Shop' },
                'beach_resort': { name: 'Beach Resort', description: 'Stamina ‡∏•‡∏î‡∏ä‡πâ‡∏≤‡∏•‡∏á 15%', image: 'https://placehold.co/400x200/eff6ff/1d4ed8?text=Resort' },
                'ancient_forest': { name: 'Ancient Forest', description: 'EXP +15% ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à', image: 'https://placehold.co/400x200/f7fee7/3f6212?text=Ancient+Forest' },
                'cozy_bedroom': { name: '‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà', description: '‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô 25%', image: 'https://placehold.co/400x200/faf5ff/6b21a8?text=Cozy+Bedroom' },
                'grand_kitchen': { name: '‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà', description: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏¥‡πà‡∏° +25%', image: 'https://placehold.co/400x200/fff7ed/c2410c?text=Grand+Kitchen' },
                'toy_gallery': { name: '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô', description: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô +25%', image: 'https://placehold.co/400x200/fef9c3/ca8a04?text=Toy+Gallery' },
                'sky_palace_legendary': { name: 'Sky Palace (Legendary)', description: '‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á +10%', image: 'https://placehold.co/400x200/fefce8/b45309?text=Legendary+Palace' },
            };

            const staminaItems = {
                'item_m150': { stamina: 20 },
                'item_latte': { stamina: 30 },
                'item_americano': { stamina: 50 },
            };

            const petToys = {
                '‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏¢‡∏≤‡∏á': { happiness: 20, exp: 5 },
                '‡∏•‡∏π‡∏Å‡∏ö‡∏≠‡∏•': { happiness: 25, exp: 5 },
                '‡∏Å‡∏µ‡∏ï‡πâ‡∏≤': { happiness: 40, exp: 10 },
                '‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå': { happiness: 50, exp: 15 },
            };

            const allPlayableGames = [
                { id: 'rps', name: '‡πÄ‡∏õ‡πà‡∏≤‡∏¢‡∏¥‡πâ‡∏á‡∏â‡∏∏‡∏ö', file: 'rps_game.html' },
                { id: 'memory', name: '‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏†‡∏≤‡∏û', file: 'memory_game.html' },
                { id: 'simon', name: '‡πÄ‡∏Å‡∏°‡∏Å‡∏î‡∏ï‡∏≤‡∏°‡∏°‡πà‡∏≠‡∏ô', file: 'simon_game.html' },
                { id: 'whac_a_mole', name: '‡πÄ‡∏Å‡∏°‡∏ï‡∏µ‡∏´‡∏±‡∏ß‡∏°‡πà‡∏≠‡∏ô', file: 'whac_a_mole_game.html' },
                { id: 'catch_object', name: '‡∏£‡∏±‡∏ö‡∏°‡πà‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢!', file: 'catch_falling_object.html' },
                { id: 'cafe', name: '‡πÄ‡∏Å‡∏°‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà', file: 'cafe.html' },
            ];
            
            const explorationLocations = {
                'garden': { 
                    name: '‡∏™‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô', 
                    exp: 5,
                    rewards: [
                        { type: 'mon_coin', name: '‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏°‡πà‡∏≠‡∏ô', amount: '5-10', chance: 100 },
                        { type: 'play_coin', name: '‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÄ‡∏•‡πà‡∏ô‡∏°‡πà‡∏≠‡∏ô', amount: '1-2', chance: 90 },
                        { type: 'item', name: '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á', chance: 60 },
                        { type: 'item', name: '‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏¢‡∏≤‡∏á', chance: 60 },
                        { type: 'item', name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®', chance: 60 },
                        { type: 'background', name: 'bedroom', chance: 10 },
                        { type: 'background', name: 'beach', chance: 10 }
                    ]
                },
                'market': { 
                    name: '‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô', 
                    exp: 10,
                    rewards: [
                        { type: 'mon_coin', name: '‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏°‡πà‡∏≠‡∏ô', amount: '20-30', chance: 100 },
                        { type: 'play_coin', name: '‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÄ‡∏•‡πà‡∏ô‡∏°‡πà‡∏≠‡∏ô', amount: '3-4', chance: 90 },
                        { type: 'item', name: '‡πÄ‡∏Ñ‡πâ‡∏Å', chance: 50 },
                        { type: 'item', name: '‡∏•‡∏π‡∏Å‡∏ö‡∏≠‡∏•', chance: 50 },
                        { type: 'item', name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó', chance: 50 },
                        { type: 'background', name: 'restaurant', chance: 10 },
                        { type: 'background', name: 'amusement_park', chance: 10 }
                    ]
                },
                'beach': { 
                    name: '‡∏ä‡∏≤‡∏¢‡∏´‡∏≤‡∏î‡∏™‡∏≤‡∏¢‡∏£‡∏∏‡πâ‡∏á', 
                    exp: 20,
                    rewards: [
                        { type: 'mon_coin', name: '‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏°‡πà‡∏≠‡∏ô', amount: '60-90', chance: 100 },
                        { type: 'item', name: '‡πÑ‡∏≠‡∏®‡∏Å‡∏£‡∏µ‡∏°', chance: 40 },
                        { type: 'item', name: '‡∏Å‡∏µ‡∏ï‡πâ‡∏≤', chance: 40 },
                        { type: 'item', name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏ö‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏•‡∏µ', chance: 40 },
                        { type: 'item', name: 'ticket_random', chance: 15 },
                        { type: 'background', name: 'vegetable_garden', chance: 10 }
                    ]
                },
                'forest': { 
                    name: '‡∏õ‡πà‡∏≤‡∏°‡∏´‡∏±‡∏®‡∏à‡∏£‡∏£‡∏¢‡πå', 
                    exp: 30,
                    rewards: [
                        { type: 'mon_coin', name: '‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏°‡πà‡∏≠‡∏ô', amount: '120-180', chance: 100 },
                        { type: 'item', name: '‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå', chance: 20 },
                        { type: 'item', name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ', chance: 20 },
                        { type: 'item', name: 'ticket_trip', chance: 10 },
                        { type: 'item', name: 'ticket_command', chance: 5 },
                        { type: 'background', name: 'forest', chance: 10 }
                    ]
                }
            };
            
            const gachaPrizes = [
                { name: '1 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÄ‡∏•‡πà‡∏ô‡∏°‡πà‡∏≠‡∏ô', type: 'play_coin', value: 1, probability: 39, rarity: 'common' },
                { name: '2 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÄ‡∏•‡πà‡∏ô‡∏°‡πà‡∏≠‡∏ô', type: 'play_coin', value: 2, probability: 24, rarity: 'common' },
                { name: '3 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÄ‡∏•‡πà‡∏ô‡∏°‡πà‡∏≠‡∏ô', type: 'play_coin', value: 3, probability: 10, rarity: 'common' },
                { name: '4 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÄ‡∏•‡πà‡∏ô‡∏°‡πà‡∏≠‡∏ô', type: 'play_coin', value: 4, probability: 5, rarity: 'rare' },
                { name: '5 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÄ‡∏•‡πà‡∏ô‡∏°‡πà‡∏≠‡∏ô', type: 'play_coin', value: 5, probability: 5, rarity: 'rare' },
                { name: '‡∏ï‡∏±‡πã‡∏ß‡∏™‡∏∏‡πà‡∏°‡∏ß‡∏á‡∏•‡πâ‡∏≠', type: 'item', value: 'ticket_random', probability: 7, rarity: 'rare' },
                { name: '‡∏ï‡∏±‡πã‡∏ß‡πÉ‡∏´‡πâ‡∏û‡∏≤‡πÑ‡∏õ‡πÑ‡∏´‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ', type: 'item', value: 'ticket_trip', probability: 6, rarity: 'epic' },
                { name: '‡∏ï‡∏±‡πã‡∏ß‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡πâ‡∏≤‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ', type: 'item', value: 'ticket_command', probability: 3, rarity: 'epic' },
                { name: '‡∏ï‡∏±‡πã‡∏ß‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ', type: 'item', value: 'ticket_wish', probability: 1, rarity: 'legendary' },
            ];

            const petEmotions = {
                normal: 'idle.gif',
                happy: 'happy.png',
                sad: 'cry.png',
                angry: 'angry.png',
            };
            
            const upgradeCosts = [100, 200, 400, 800, 1000];
            const maxUpgradeLevel = 5;
            
            const petFoodDefinitions = {
                '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á': { hunger: 15, exp: 5, cost: 10 },
                '‡πÄ‡∏Ñ‡πâ‡∏Å': { hunger: 30, exp: 12, cost: 25 },
                '‡πÑ‡∏≠‡∏®‡∏Å‡∏£‡∏µ‡∏°': { hunger: 50, exp: 20, cost: 40 },
                '‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®': { hunger: 20, exp: 8, cost: 0 },
                '‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó': { hunger: 20, exp: 10, cost: 0 },
                '‡∏ö‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏•‡∏µ': { hunger: 25, exp: 12, cost: 0 },
                '‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ': { hunger: 30, exp: 20, cost: 0 },
            };

            // ===================================================================
            // ===== START: ACHIEVEMENT DEFINITIONS ==============================
            // ===================================================================
            const achievementDefinitions = {
                // --- Feeding Achievements ---
                'feed_bread': {
                    category: '‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', name: '‡∏ô‡∏±‡∏Å‡∏ä‡∏¥‡∏°‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á üçû', icon: 'üçû',
                    tiers: [
                        { goal: 5, rewards: { exp: 10, play_coin: 1 } },
                        { goal: 10, rewards: { exp: 20, play_coin: 2 } },
                        { goal: 30, rewards: { exp: 40, play_coin: 3 } },
                        { goal: 50, rewards: { exp: 60, play_coin: 4 } },
                        { goal: 70, rewards: { exp: 80, play_coin: 5 } },
                        { goal: 100, rewards: { exp: 100, background: 'mythical_garden' } },
                    ]
                },
                'feed_cake': {
                    category: '‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', name: '‡∏Ñ‡∏ô‡∏£‡∏±‡∏Å‡πÄ‡∏Ñ‡πâ‡∏Å üç∞', icon: 'üç∞',
                    tiers: [
                        { goal: 5, rewards: { exp: 15, play_coin: 1 } },
                        { goal: 10, rewards: { exp: 25, play_coin: 2 } },
                        { goal: 30, rewards: { exp: 50, play_coin: 3 } },
                        { goal: 50, rewards: { exp: 70, play_coin: 4 } },
                        { goal: 70, rewards: { exp: 90, play_coin: 5 } },
                        { goal: 100, rewards: { exp: 120, background: 'crystal_chamber' } },
                    ]
                },
                'feed_icecream': {
                    category: '‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', name: '‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÑ‡∏≠‡∏®‡∏Å‡∏£‡∏µ‡∏° üç¶', icon: 'üç¶',
                    tiers: [
                        { goal: 5, rewards: { exp: 20, play_coin: 1 } },
                        { goal: 10, rewards: { exp: 30, play_coin: 2 } },
                        { goal: 30, rewards: { exp: 60, play_coin: 3 } },
                        { goal: 50, rewards: { exp: 80, play_coin: 4 } },
                        { goal: 70, rewards: { exp: 100, play_coin: 5 } },
                        { goal: 100, rewards: { exp: 150, background: 'sky_palace' } },
                    ]
                },
                'feed_tomato': {
                    category: '‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', name: '‡∏ä‡∏≤‡∏ß‡∏™‡∏ß‡∏ô‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏® üçÖ', icon: 'üçÖ',
                    tiers: [
                        { goal: 5, rewards: { exp: 8, item: { id: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®', amount: 1 } } },
                        { goal: 10, rewards: { exp: 16, item: { id: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®', amount: 1 } } },
                        { goal: 30, rewards: { exp: 35, item: { id: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®', amount: 2 } } },
                        { goal: 50, rewards: { exp: 55, item: { id: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®', amount: 3 } } },
                        { goal: 70, rewards: { exp: 75, item: { id: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®', amount: 4 } } },
                        { goal: 100, rewards: { exp: 100, background: 'vegetable_garden' } },
                    ]
                },
                'feed_carrot': {
                    category: '‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', name: '‡∏ô‡∏±‡∏Å‡∏õ‡∏•‡∏π‡∏Å‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó ü•ï', icon: 'ü•ï',
                    tiers: [
                        { goal: 5, rewards: { exp: 10, item: { id: '‡πÄ‡∏°‡∏•‡πá‡∏î‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó', amount: 1 } } },
                        { goal: 10, rewards: { exp: 20, item: { id: '‡πÄ‡∏°‡∏•‡πá‡∏î‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó', amount: 1 } } },
                        { goal: 30, rewards: { exp: 40, item: { id: '‡πÄ‡∏°‡∏•‡πá‡∏î‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó', amount: 2 } } },
                        { goal: 50, rewards: { exp: 60, item: { id: '‡πÄ‡∏°‡∏•‡πá‡∏î‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó', amount: 3 } } },
                        { goal: 70, rewards: { exp: 80, item: { id: '‡πÄ‡∏°‡∏•‡πá‡∏î‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó', amount: 4 } } },
                        { goal: 100, rewards: { exp: 110, background: 'forest' } },
                    ]
                },
                'feed_broccoli': {
                    category: '‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', name: '‡πÅ‡∏ü‡∏ô‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡πÅ‡∏ó‡πâ‡∏ö‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏•‡∏µ ü•¶', icon: 'ü•¶',
                    tiers: [
                        { goal: 5, rewards: { exp: 12, item: { id: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏ö‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏•‡∏µ', amount: 1 } } },
                        { goal: 10, rewards: { exp: 24, item: { id: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏ö‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏•‡∏µ', amount: 1 } } },
                        { goal: 30, rewards: { exp: 48, item: { id: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏ö‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏•‡∏µ', amount: 2 } } },
                        { goal: 50, rewards: { exp: 70, item: { id: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏ö‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏•‡∏µ', amount: 3 } } },
                        { goal: 70, rewards: { exp: 90, item: { id: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏ö‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏•‡∏µ', amount: 4 } } },
                        { goal: 100, rewards: { exp: 120, background: 'library' } },
                    ]
                },
                'feed_strawberry': {
                    category: '‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', name: '‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏´‡πà‡∏á‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ üçì', icon: 'üçì',
                    tiers: [
                        { goal: 5, rewards: { exp: 15, item: { id: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ', amount: 1 } } },
                        { goal: 10, rewards: { exp: 30, item: { id: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ', amount: 1 } } },
                        { goal: 30, rewards: { exp: 60, item: { id: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ', amount: 2 } } },
                        { goal: 50, rewards: { exp: 80, item: { id: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ', amount: 3 } } },
                        { goal: 70, rewards: { exp: 100, item: { id: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ', amount: 4 } } },
                        { goal: 100, rewards: { exp: 150, background: 'magical_aquarium' } },
                    ]
                },
                // --- Toy Achievements ---
                'play_rubber_toy': {
                    category: '‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô', name: '‡∏ô‡∏±‡∏Å‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏¢‡∏≤‡∏á', icon: 'üß∏',
                    tiers: [
                        { goal: 5, rewards: { exp: 10 } },
                        { goal: 15, rewards: { play_coin: 2 } },
                        { goal: 30, rewards: { exp: 30 } },
                        { goal: 50, rewards: { exp: 50, item: { id: '‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏¢‡∏≤‡∏á', amount: 1 } } },
                        { goal: 100, rewards: { background: 'playroom' } },
                    ]
                },
                'play_ball': {
                    category: '‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô', name: '‡∏ô‡∏±‡∏Å‡πÄ‡∏•‡πà‡∏ô‡∏ö‡∏≠‡∏•', icon: '‚öΩ',
                    tiers: [
                        { goal: 5, rewards: { exp: 10 } },
                        { goal: 15, rewards: { play_coin: 2 } },
                        { goal: 30, rewards: { exp: 30 } },
                        { goal: 50, rewards: { exp: 50 } },
                        { goal: 100, rewards: { background: 'playground' } },
                    ]
                },
                'play_guitar': {
                    category: '‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô', name: '‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏ï‡πâ‡∏≤‡∏£‡πå', icon: 'üé∏',
                    tiers: [
                        { goal: 5, rewards: { exp: 15 } },
                        { goal: 15, rewards: { play_coin: 3 } },
                        { goal: 30, rewards: { exp: 40 } },
                        { goal: 50, rewards: { exp: 60 } },
                        { goal: 100, rewards: { background: 'music_room' } },
                    ]
                },
                'play_computer': {
                    category: '‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô', name: '‡πÄ‡∏ã‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå', icon: 'üíª',
                    tiers: [
                        { goal: 5, rewards: { exp: 20 } },
                        { goal: 15, rewards: { play_coin: 3 } },
                        { goal: 30, rewards: { exp: 50 } },
                        { goal: 50, rewards: { exp: 70 } },
                        { goal: 100, rewards: { background: 'digital_nexus' } },
                    ]
                },
                // --- Stamina Item Achievements ---
                'use_m150': {
                    category: '‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏•‡∏±‡∏á', name: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ M150', icon: '‚ö°',
                    tiers: [
                        { goal: 5, rewards: { exp: 10 } },
                        { goal: 15, rewards: { play_coin: 2 } },
                        { goal: 30, rewards: { exp: 40 } },
                        { goal: 50, rewards: { background: 'gym_room' } },
                    ]
                },
                'use_latte': {
                    category: '‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏•‡∏±‡∏á', name: '‡∏Ñ‡∏≠‡∏Å‡∏≤‡πÅ‡∏ü‡∏•‡∏≤‡πÄ‡∏ï‡πâ', icon: '‚òï',
                    tiers: [
                        { goal: 5, rewards: { exp: 10 } },
                        { goal: 15, rewards: { play_coin: 2 } },
                        { goal: 30, rewards: { exp: 40 } },
                        { goal: 50, rewards: { background: 'cute_cafe' } },
                    ]
                },
                'use_americano': {
                    category: '‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏•‡∏±‡∏á', name: '‡∏™‡∏≤‡∏¢‡∏î‡∏≤‡∏£‡πå‡∏Å‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤‡πÇ‡∏ô‡πà', icon: '‚òï',
                    tiers: [
                        { goal: 5, rewards: { exp: 15 } },
                        { goal: 15, rewards: { play_coin: 3 } },
                        { goal: 30, rewards: { exp: 50 } },
                        { goal: 50, rewards: { background: 'coffee_lounge' } },
                    ]
                },
                // --- Exploration Achievements ---
                'explore_garden': {
                    category: '‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à', name: '‡∏ô‡∏±‡∏Å‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏™‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô', icon: 'üß≠',
                    tiers: [
                        { goal: 3, rewards: { exp: 10 } },
                        { goal: 10, rewards: { play_coin: 2 } },
                        { goal: 30, rewards: { exp: 40 } },
                        { goal: 50, rewards: { background: 'secret_garden' } },
                    ]
                },
                'explore_market': {
                    category: '‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à', name: '‡∏ô‡∏±‡∏Å‡∏ä‡πâ‡∏≠‡∏õ‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡∏±‡∏î', icon: 'üß≠',
                    tiers: [
                        { goal: 3, rewards: { exp: 12 } },
                        { goal: 10, rewards: { play_coin: 3 } },
                        { goal: 30, rewards: { exp: 45 } },
                        { goal: 50, rewards: { background: 'hidden_shop' } },
                    ]
                },
                'explore_beach': {
                    category: '‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à', name: '‡∏ô‡∏±‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ó‡∏∞‡πÄ‡∏•', icon: 'üß≠',
                    tiers: [
                        { goal: 3, rewards: { exp: 15 } },
                        { goal: 10, rewards: { play_coin: 3 } },
                        { goal: 30, rewards: { exp: 60 } },
                        { goal: 50, rewards: { background: 'beach_resort' } },
                    ]
                },
                'explore_forest': {
                    category: '‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à', name: '‡∏ô‡∏±‡∏Å‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡∏õ‡πà‡∏≤', icon: 'üß≠',
                    tiers: [
                        { goal: 3, rewards: { exp: 20 } },
                        { goal: 10, rewards: { play_coin: 4 } },
                        { goal: 30, rewards: { exp: 70 } },
                        { goal: 50, rewards: { background: 'ancient_forest' } },
                    ]
                },
                // --- Upgrade Achievements ---
                'upgrade_bed': {
                    category: '‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏ö‡πâ‡∏≤‡∏ô', name: '‡∏ô‡∏±‡∏Å‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏ï‡∏µ‡∏¢‡∏á', icon: 'üè†',
                    tiers: [
                        { goal: 1, rewards: { exp: 20 } },
                        { goal: 2, rewards: { play_coin: 5 } }, // Custom reward
                        { goal: 3, rewards: { play_coin: 5 } }, // Custom reward
                        { goal: 4, rewards: { exp: 50 } }, // Custom reward
                        { goal: 5, rewards: { background: 'cozy_bedroom' } },
                    ]
                },
                'upgrade_bowl': {
                    category: '‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏ö‡πâ‡∏≤‡∏ô', name: '‡∏ô‡∏±‡∏Å‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ä‡∏≤‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£', icon: 'üè†',
                    tiers: [
                        { goal: 1, rewards: { exp: 20 } },
                        { goal: 2, rewards: { play_coin: 5 } },
                        { goal: 3, rewards: { play_coin: 5 } },
                        { goal: 4, rewards: { exp: 50 } },
                        { goal: 5, rewards: { background: 'grand_kitchen' } },
                    ]
                },
                'upgrade_toy_shelf': {
                    category: '‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏ö‡πâ‡∏≤‡∏ô', name: '‡∏ô‡∏±‡∏Å‡∏™‡∏∞‡∏™‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô', icon: 'üè†',
                    tiers: [
                        { goal: 1, rewards: { exp: 20 } },
                        { goal: 2, rewards: { play_coin: 5 } },
                        { goal: 3, rewards: { play_coin: 5 } },
                        { goal: 4, rewards: { exp: 50 } },
                        { goal: 5, rewards: { background: 'toy_gallery' } },
                    ]
                },
                 'upgrade_all_max': {
                    category: '‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏ö‡πâ‡∏≤‡∏ô', name: '‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏´‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏ö‡πâ‡∏≤‡∏ô', icon: 'üëë',
                    isSpecial: true, // This is a special flag
                    tiers: [
                        { goal: 1, rewards: { background: 'sky_palace_legendary' } },
                    ]
                }
            };

            // ===================================================================
            // ===== END: ACHIEVEMENT DEFINITIONS ================================
            // ===================================================================


            // DOM Elements
            const screens = {
                menu: document.getElementById('menu-screen'),
                shop: document.getElementById('shop-screen'),
            };
            const coinDisplays = {
                mon: document.getElementById('mon-coin-display'),
                play: document.getElementById('play-coin-display'),
            };
            const checkInBtn = document.getElementById('check-in-btn');
            const dailyMissionsList = document.getElementById('daily-missions-list');
            const shopItemsList = document.getElementById('shop-items-list');
            const inventoryCard = document.getElementById('inventory-card');
            const inventoryList = document.getElementById('inventory-list');
            const bonusGameSection = document.getElementById('bonus-game-section'); 
            const dailyBonusGameName = document.getElementById('daily-bonus-game-name'); 
            const gameCardContainer = document.getElementById('game-card-container');
            
            const gachaPullBtn = document.getElementById('gacha-pull-btn');
            const gachaRatesBtn = document.getElementById('gacha-rates-btn');
            const gachaModal = document.getElementById('gacha-modal');
            const gachaTitle = document.getElementById('gacha-title');
            const gachaReel = document.getElementById('gacha-reel');
            const gachaResult = document.getElementById('gacha-result');
            const gachaPrizeText = document.getElementById('gacha-prize-text');
            const closeGachaModalBtn = document.getElementById('close-gacha-modal-btn');
            const gachaRatesModal = document.getElementById('gacha-rates-modal');
            const gachaRatesList = document.getElementById('gacha-rates-list');
            const closeGachaRatesModalBtn = document.getElementById('close-gacha-rates-modal-btn');

            const floatingPetContainer = document.getElementById('floating-pet-container');
            const floatingPetImage = document.getElementById('floating-pet-image');
            const petSpeechBubble = document.getElementById('pet-speech-bubble');
            const petStatsModal = document.getElementById('pet-stats-modal');
            const closePetStatsModalBtn = document.getElementById('close-pet-stats-modal-btn');
            const petDisplayArea = document.getElementById('pet-display-area');
            const petNameEl = document.getElementById('pet-name');
            const petLevelEl = document.getElementById('pet-level');
            const petModalImageEl = document.getElementById('pet-modal-image');
            const petExpText = document.getElementById('pet-exp-text');
            const petExpBar = document.getElementById('pet-exp-bar');
            const petHungerText = document.getElementById('pet-hunger-text');
            const petHungerBar = document.getElementById('pet-hunger-bar');
            const petHappinessText = document.getElementById('pet-happiness-text');
            const petHappinessBar = document.getElementById('pet-happiness-bar');
            const petStaminaText = document.getElementById('pet-stamina-text');
            const petStaminaBar = document.getElementById('pet-stamina-bar');
            const feedPetBtn = document.getElementById('feed-pet-btn');
            const playWithPetBtn = document.getElementById('play-with-pet-btn');
            const petActionButtons = document.getElementById('pet-action-buttons');
            const petExplorationStatusInModal = document.getElementById('pet-exploration-status-in-modal');
            const petExplorationLocationInModal = document.getElementById('pet-exploration-location-in-modal');
            const petExplorationTimerInModal = document.getElementById('pet-exploration-timer-in-modal');
            
            const changeBgBtn = document.getElementById('change-bg-btn');
            const backgroundModal = document.getElementById('background-modal');
            const closeBackgroundModalBtn = document.getElementById('close-background-modal-btn');
            const petBackgroundList = document.getElementById('pet-background-list');
            const petBackgroundBuffDisplay = document.getElementById('pet-background-buff-display');

            const upgradePetBtn = document.getElementById('upgrade-pet-btn');
            const upgradeModal = document.getElementById('upgrade-modal');
            const closeUpgradeModalBtn = document.getElementById('close-upgrade-modal-btn');
            const upgradeList = document.getElementById('upgrade-list');
            const useItemBtn = document.getElementById('use-item-btn');
            const useItemModal = document.getElementById('use-item-modal');
            const closeUseItemModalBtn = document.getElementById('close-use-item-modal-btn');
            const itemUseList = document.getElementById('item-use-list');

            const hatchModal = document.getElementById('hatch-modal');
            const eggStage = document.getElementById('egg-stage');
            const nameStage = document.getElementById('name-stage');
            const eggImage = document.getElementById('egg-image');
            const eggTapsText = document.getElementById('egg-taps');
            const petNameInput = document.getElementById('pet-name-input');
            const confirmNameBtn = document.getElementById('confirm-name-btn');
            
            const feedModal = document.getElementById('feed-modal');
            const foodList = document.getElementById('food-list');
            const closeFeedModalBtn = document.getElementById('close-feed-modal-btn');

            const playModal = document.getElementById('play-modal');
            const playOptionsList = document.getElementById('play-options-list');
            const closePlayModalBtn = document.getElementById('close-play-modal-btn');

            const explorationStatusCard = document.getElementById('exploration-status-card');
            const explorationTimerEl = document.getElementById('exploration-timer');
            const explorationStatusText = document.getElementById('exploration-status-text');
            const claimRewardsBtn = document.getElementById('claim-rewards-btn');
            
            const achievementsBtn = document.getElementById('achievements-btn');
            const achievementNotification = document.getElementById('achievement-notification');
            const achievementsModal = document.getElementById('achievements-modal');
            const achievementsContent = document.getElementById('achievements-content');
            const closeAchievementsModalBtn = document.getElementById('close-achievements-modal-btn');

            let eggTaps = 0;
            const TAPS_TO_HATCH = 20;


            // --- State Management ---
            function saveState() {
                localStorage.setItem('monGameDataV17', JSON.stringify(state));
            }

            function loadState() {
                const savedData = localStorage.getItem('monGameDataV17');
                if (savedData) {
                    state = JSON.parse(savedData);
                    // Migration and default value checks for new features
                    if (!state.shopItemLevels) {
                        state.shopItemLevels = {};
                        shopItemDefinitions.forEach(item => { state.shopItemLevels[item.id] = 0; });
                    }
                    if (!state.pet) { 
                        state.pet = { exists: false };
                    }
                    if (state.pet.exists) {
                        if (!state.pet.hasOwnProperty('stamina')) state.pet.stamina = 100;
                        if (!state.pet.hasOwnProperty('exploration')) state.pet.exploration = null;
                        if (!state.pet.hasOwnProperty('lastStatusUpdate')) state.pet.lastStatusUpdate = Date.now();
                        if (!state.pet.hasOwnProperty('lastPattedDate')) state.pet.lastPattedDate = null;
                        if (!state.pet.ownedBackgrounds) state.pet.ownedBackgrounds = ['default'];
                        if (!state.pet.activeBackground) state.pet.activeBackground = 'default';
                        if (!state.pet.upgradeLevels) {
                            state.pet.upgradeLevels = { bed: 0, bowl: 0, toy_shelf: 0 };
                        }
                    }
                    if (!state.achievementProgress) state.achievementProgress = {};
                    if (!state.achievementStatus) state.achievementStatus = {};

                } else {
                    state = {
                        monCoins: 100, 
                        playCoins: 5, 
                        lastCheckinDate: null, 
                        dailyMissions: [],
                        lastMissionDate: null, 
                        inventory: {},
                        dailyBonusGameId: null,
                        lastBonusGameDate: null,
                        shopItemLevels: {},
                        pet: {
                            exists: false, name: '', level: 1, exp: 0, hunger: 100, happiness: 100,
                            stamina: 100, exploration: null,
                            lastPattedDate: null, lastStatusUpdate: Date.now(),
                            ownedBackgrounds: ['default'], activeBackground: 'default',
                            upgradeLevels: { bed: 0, bowl: 0, toy_shelf: 0 }
                        },
                        achievementProgress: {},
                        achievementStatus: {}
                    };
                    shopItemDefinitions.forEach(item => { state.shopItemLevels[item.id] = 0; });
                    generateNewMissions();
                }
            }

            // --- UI Rendering ---
            function updateCoinDisplays() {
                coinDisplays.mon.textContent = state.monCoins;
                coinDisplays.play.textContent = state.playCoins;
            }

            function showScreen(screenName) {
                Object.values(screens).forEach(s => s.classList.add('hidden'));
                screens[screenName].classList.remove('hidden');
                if (screenName === 'menu') {
                    renderInventory(); 
                    displayBonusGame();
                }
            }
            
            function renderInventory() {
                inventoryList.innerHTML = '';
                const userItems = Object.keys(state.inventory).filter(key => state.inventory[key] > 0);

                if (userItems.length > 0) {
                    userItems.forEach(itemId => {
                        const itemDetails = consumableItems[itemId]; 
                        if (itemDetails) {
                            const itemEl = document.createElement('div');
                            itemEl.className = 'flex justify-between items-center bg-rose-50 p-3 rounded-lg border-l-4 border-rose-200 text-lg text-pink-700';
                            itemEl.innerHTML = `
                                <span class="font-semibold">${itemDetails.name}</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-base font-bold bg-pink-200 text-pink-600 rounded-full px-3 py-1 ml-2">x${state.inventory[itemId]}</span>
                                </div>
                            `;
                            inventoryList.appendChild(itemEl);
                        }
                    });
                    inventoryCard.classList.remove('hidden');
                } else {
                    inventoryCard.classList.add('hidden');
                }
            }
            
            function updateCheckInButton() {
                const today = new Date().toDateString();
                if (state.lastCheckinDate === today) {
                    checkInBtn.textContent = '‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ!';
                    checkInBtn.disabled = true;
                } else {
                    checkInBtn.textContent = '‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô (‡∏£‡∏±‡∏ö 5 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç)';
                    checkInBtn.disabled = false;
                }
            }
            
            function renderMissions() {
                dailyMissionsList.innerHTML = '';
                state.dailyMissions.forEach((mission, index) => {
                    const missionEl = document.createElement('div');
                    const isCompleted = mission.completed;
                    missionEl.className = `flex justify-between items-center bg-pink-50 p-3 rounded-lg border-l-4 border-pink-200 text-base text-gray-600 transition-opacity duration-300 ${isCompleted ? 'opacity-60' : ''}`;
                    const btnClass = isCompleted ? 'bg-gradient-to-br from-green-400 to-emerald-500 border-green-600' : 'bg-gradient-to-br from-pink-400 to-rose-400 border-pink-600';
                    const btnContent = isCompleted ? `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5l10 -10" /></svg>` : '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
                    missionEl.innerHTML = `<p class="font-medium transition-all duration-300 ${isCompleted ? 'line-through' : ''}">${mission.text}</p><button data-index="${index}" class="btn-base text-sm px-3 py-2 rounded-xl font-semibold text-white shadow-md flex items-center justify-center border-b-4 ml-2 ${btnClass}">${btnContent}</button>`;
                    dailyMissionsList.appendChild(missionEl);
                });

                document.querySelectorAll('button[data-index]').forEach(btn => {
                    const index = btn.dataset.index;
                    const mission = state.dailyMissions[index];
                    if (!mission.completed) {
                        btn.addEventListener('click', () => {
                            mission.completed = true;
                            state.playCoins += mission.reward;
                            updateCoinDisplays();
                            renderMissions();
                            saveState();
                            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                        });
                    }
                });
            }

            function renderShopItems() {
                shopItemsList.innerHTML = '';
                const categories = {};
                
                shopItemDefinitions.forEach(item => {
                    if (!categories[item.category]) {
                        categories[item.category] = [];
                    }
                    categories[item.category].push(item);
                });

                for (const categoryName in categories) {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.className = 'text-xl font-bold text-pink-500 mb-2 mt-4 first:mt-0';
                    categoryHeader.textContent = categoryName;
                    shopItemsList.appendChild(categoryHeader);

                    categories[categoryName].forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'card-base flex justify-between items-center bg-white p-4 rounded-2xl border-l-8 border-amber-300';
                        
                        let buttonHtml = '';
                        let priceText = '';
                        let finalPrice = item.basePrice;

                        // Apply discount from achievement
                        const hiddenShopUnlocked = state.pet.ownedBackgrounds.includes('hidden_shop');
                        if (hiddenShopUnlocked) {
                            finalPrice = Math.round(finalPrice * 0.9);
                        }
                        
                        if (item.type === 'ticket') {
                            const currentLevel = state.shopItemLevels[item.id] || 0;
                            finalPrice = finalPrice * Math.pow(2, currentLevel);
                        }

                        priceText = `${finalPrice} <img src="mon_coin_icon.png" class="w-5 h-5 ml-1" onerror="this.style.display='none'">`;
                        
                        if (item.type === 'background') {
                            const isOwned = state.pet.ownedBackgrounds.includes(item.id);
                            buttonHtml = `<button data-price="${finalPrice}" data-id="${item.id}" data-type="${item.type}" class="buy-item-btn btn-base px-5 py-2 text-base font-bold text-white rounded-xl shadow-lg flex items-center justify-center border-b-4 ml-3 ${isOwned ? 'bg-gray-400 border-gray-500 cursor-not-allowed' : 'bg-gradient-to-br from-pink-500 to-rose-500 border-rose-700'}">${isOwned ? '‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß' : '‡∏ã‡∏∑‡πâ‡∏≠'}</button>`;
                        } else {
                            buttonHtml = `<button data-price="${finalPrice}" data-id="${item.id}" data-type="${item.type}" class="buy-item-btn btn-base px-5 py-2 text-base font-bold text-white rounded-xl shadow-lg flex items-center justify-center border-b-4 bg-gradient-to-br from-pink-500 to-rose-500 border-rose-700 ml-3">‡∏ã‡∏∑‡πâ‡∏≠</button>`;
                        }

                        itemEl.innerHTML = `
                            <div>
                                <p class="text-lg font-semibold text-gray-700">${item.name}</p>
                                <p class="text-base font-bold text-amber-500 flex items-center">${priceText}</p>
                            </div>
                            ${buttonHtml}`;
                        
                        shopItemsList.appendChild(itemEl);
                    });
                }

                document.querySelectorAll('.buy-item-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const target = e.currentTarget;
                        const price = parseInt(target.dataset.price);
                        const itemId = target.dataset.id;
                        const itemType = target.dataset.type;

                        if (target.textContent.trim() === '‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß') return;

                        if (state.monCoins >= price) {
                            state.monCoins -= price;
                            if (itemType === 'background') {
                                if (!state.pet.ownedBackgrounds.includes(itemId)) {
                                    state.pet.ownedBackgrounds.push(itemId);
                                }
                            } else {
                                state.inventory[itemId] = (state.inventory[itemId] || 0) + 1;
                                if (itemType === 'ticket') {
                                     state.shopItemLevels[itemId] = (state.shopItemLevels[itemId] || 0) + 1;
                                }
                            }
                            
                            updateCoinDisplays();
                            renderInventory(); 
                            saveState();
                            alert('‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                            confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 }, scalar: 1.2 });
                            renderShopItems(); 
                        } else {
                            alert('‡∏≠‡∏∏‡πä‡∏¢! ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏°‡πà‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏à‡πâ‡∏≤!');
                        }
                    });
                });
            }

            // --- Game Logic ---
            function generateNewMissions() {
                const shuffled = [...allMissions].sort(() => 0.5 - Math.random());
                state.dailyMissions = shuffled.slice(0, 5).map(mission => ({ ...mission, completed: false }));
            }

            function pickDailyBonusGame() {
                const today = new Date().toDateString();
                if (state.lastBonusGameDate !== today) {
                    const randomIndex = Math.floor(Math.random() * allPlayableGames.length);
                    state.dailyBonusGameId = allPlayableGames[randomIndex].id;
                    state.lastBonusGameDate = today;
                    saveState();
                }
                displayBonusGame();
            }

            function displayBonusGame() {
                if (!state.dailyBonusGameId) return;

                const bonusGame = allPlayableGames.find(game => game.id === state.dailyBonusGameId);
                if (bonusGame) {
                    dailyBonusGameName.textContent = bonusGame.name;
                    bonusGameSection.classList.remove('hidden');

                    gameCardContainer.querySelectorAll('.game-card').forEach(card => {
                        card.classList.remove('bonus-game');
                        const gameData = allPlayableGames.find(g => g.id === card.dataset.gameId);
                        if (gameData) {
                            card.href = `./${gameData.file}`; 
                            if (card.dataset.gameId === state.dailyBonusGameId) {
                                card.classList.add('bonus-game');
                            }
                        }
                    });
                }
            }

            // Gacha Logic
            function pullGacha() {
                const rand = Math.random() * 100;
                let cumulativeProbability = 0;
                let totalProbability = gachaPrizes.reduce((sum, p) => sum + p.probability, 0);
                
                for (const prize of gachaPrizes) {
                    cumulativeProbability += prize.probability;
                    if (rand < (cumulativeProbability / totalProbability * 100) ) {
                        return prize;
                    }
                }
                return gachaPrizes[gachaPrizes.length - 1];
            }

            function givePrize(prize) {
                switch (prize.type) {
                    case 'play_coin':
                        state.playCoins += prize.value;
                        break;
                    case 'item':
                        if (consumableItems[prize.value]) {
                           state.inventory[prize.value] = (state.inventory[prize.value] || 0) + 1;
                        }
                        break;
                }
            }

            function showGachaModal(prize) {
                gachaTitle.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏∏‡πà‡∏°...";
                gachaResult.classList.add('hidden');
                closeGachaModalBtn.classList.add('hidden');
                
                const reelItems = [];
                const reelLength = 50;
                for (let i = 0; i < reelLength; i++) {
                    if (i === reelLength - 3) {
                        reelItems.push(prize);
                    } else {
                        reelItems.push(pullGacha());
                    }
                }
                
                gachaReel.innerHTML = reelItems.map(item => `
                    <div class="gacha-item rarity-${item.rarity}">
                        <div class="gacha-item-name">${item.name}</div>
                    </div>
                `).join('');

                gachaModal.classList.add('visible');
                
                const itemWidth = 120;
                const containerWidth = gachaReel.parentElement.offsetWidth;
                const targetPosition = (reelLength - 3) * itemWidth;
                const offset = (containerWidth / 2) - (itemWidth / 2);
                const randomJitter = Math.random() * (itemWidth - 20) - ((itemWidth - 20) / 2);
                const finalPosition = -(targetPosition - offset + randomJitter);

                gachaReel.style.transition = 'none';
                gachaReel.style.transform = `translateX(0px)`;
                
                gachaReel.offsetHeight; 

                gachaReel.style.transition = 'transform 5s cubic-bezier(0.2, 0.8, 0.2, 1)';
                gachaReel.style.transform = `translateX(${finalPosition}px)`;

                gachaReel.addEventListener('transitionend', () => {
                    const winningIndex = reelLength - 3;
                    const winningEl = gachaReel.children[winningIndex];
                    if (winningEl) {
                        winningEl.classList.add('winning-item');
                    }

                    let confettiOptions = { particleCount: 100, spread: 70, origin: { y: 0.6 } };
                    if (prize.rarity === 'rare') {
                        confettiOptions = { ...confettiOptions, particleCount: 150, spread: 100, colors: ['#60a5fa', '#3b82f6', '#ffffff'] };
                    } else if (prize.rarity === 'epic') {
                        confettiOptions = { ...confettiOptions, particleCount: 200, spread: 120, colors: ['#a855f7', '#9333ea', '#ffffff', '#fcd34d'] };
                    } else if (prize.rarity === 'legendary') {
                        confettiOptions = { particleCount: 400, spread: 360, startVelocity: 30, decay: 0.9, gravity: 1, drift: 0, ticks: 200, origin: { y: 0.5 }, colors: ['#f59e0b', '#d97706', '#fefce8', '#ffffff'] };
                    }
                    
                    setTimeout(() => {
                        gachaTitle.textContent = "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢!";
                        gachaPrizeText.textContent = prize.name;
                        gachaResult.classList.remove('hidden');
                        closeGachaModalBtn.classList.remove('hidden');
                        confetti(confettiOptions);
                    }, 400); 

                }, { once: true });
            }


            function hideGachaModal() {
                gachaModal.classList.remove('visible');
            }
            
            function showGachaRatesModal() {
                gachaRatesList.innerHTML = '';
                gachaPrizes.forEach(prize => {
                    const rateEl = document.createElement('div');
                    rateEl.className = 'flex justify-between items-center text-gray-700';
                    rateEl.innerHTML = `<span>${prize.name}</span> <span class="font-bold text-pink-500">${prize.probability}%</span>`;
                    gachaRatesList.appendChild(rateEl);
                });
                gachaRatesModal.classList.add('visible');
            }

            function hideGachaRatesModal() {
                gachaRatesModal.classList.remove('visible');
            }

            // --- Pet Functions ---
            function updatePetStatusOverTime() {
                if (!state.pet.exists) return;

                const now = Date.now();
                const elapsedMinutes = Math.floor((now - state.pet.lastStatusUpdate) / (1000 * 60));

                if (elapsedMinutes > 0) {
                    let hungerMultiplier = 1.0;
                    let happinessMultiplier = 1.0;
                    let staminaRegenMultiplier = 1.0;
                    let staminaDecayMultiplier = 1.0;
                    
                    const activeBg = state.pet.activeBackground;
                    if (activeBg === 'kitchen') hungerMultiplier *= 0.9;
                    if (activeBg === 'bedroom') happinessMultiplier *= 0.9;
                    if (activeBg === 'coffee_lounge') hungerMultiplier *= 0.9;
                    if (activeBg === 'gym_room') staminaRegenMultiplier *= 1.2;
                    if (activeBg === 'playground' || activeBg === 'beach_resort') {
                        staminaDecayMultiplier *= (activeBg === 'playground' ? 0.9 : 0.85);
                    }

                    const hungerLoss = Math.floor(elapsedMinutes / 7.5 * hungerMultiplier);
                    const happinessLoss = Math.floor(elapsedMinutes / 10 * happinessMultiplier);
                    
                    const bedLevel = state.pet.upgradeLevels.bed;
                    const baseRegenInterval = 10;
                    const timeReduction = bedLevel * 0.5;
                    const finalRegenInterval = Math.max(1, baseRegenInterval - timeReduction);
                    const staminaGain = Math.floor((elapsedMinutes / finalRegenInterval) * staminaRegenMultiplier);
                    
                    state.pet.hunger = Math.max(0, state.pet.hunger - hungerLoss);
                    state.pet.happiness = Math.max(0, state.pet.happiness - happinessLoss);
                    if (!state.pet.exploration || state.pet.exploration.endTime < now) {
                        state.pet.stamina = Math.min(100, state.pet.stamina + staminaGain);
                    }
                    
                    state.pet.lastStatusUpdate = now;
                    saveState();
                }
            }

            function updatePetEmotion() {
                if (!state.pet.exists) return;
                
                let currentEmotion = 'normal';
                let isBubbleVisible = false;

                if (state.pet.hunger <= 50) {
                    currentEmotion = 'sad';
                    petSpeechBubble.textContent = '‡∏´‡∏¥‡∏ß‡πÅ‡∏ô‡πâ‡∏ß‡∏ß‡∏ß';
                    isBubbleVisible = true;
                } else if (state.pet.happiness <= 50) {
                    currentEmotion = 'angry';
                    petSpeechBubble.textContent = '‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏≠';
                    isBubbleVisible = true;
                }

                if (isBubbleVisible) {
                    petSpeechBubble.classList.remove('hidden');
                } else {
                    petSpeechBubble.classList.add('hidden');
                }

                const imageUrl = petEmotions[currentEmotion];
                floatingPetImage.src = imageUrl;
                petModalImageEl.src = imageUrl;
            }


            function renderFloatingPet() {
                 if (!state.pet.exists) {
                     floatingPetContainer.classList.add('hidden');
                     return;
                 }
                 floatingPetContainer.classList.remove('hidden');
                 updatePetEmotion();
            }

            function renderPetStats() {
                if (!state.pet.exists) return;
                updatePetEmotion();
                updateAchievementNotification();

                const pet = state.pet;
                const maxExp = pet.level * 100;
                
                petNameEl.textContent = pet.name;
                petLevelEl.textContent = `Lv. ${pet.level}`;
                
                petExpText.textContent = `${pet.exp} / ${maxExp}`;
                petExpBar.style.width = `${(pet.exp / maxExp) * 100}%`;
                
                petHungerText.textContent = `${pet.hunger} / 100`;
                petHungerBar.style.width = `${pet.hunger}%`;

                petHappinessText.textContent = `${pet.happiness} / 100`;
                petHappinessBar.style.width = `${pet.happiness}%`;
                
                petStaminaText.textContent = `${pet.stamina} / 100`;
                petStaminaBar.style.width = `${pet.stamina}%`;

                const activeBg = state.pet.activeBackground;
                const bgInfo = petBackgroundDefinitions[activeBg];

                if(bgInfo) {
                    petDisplayArea.style.backgroundImage = `url('${bgInfo.image}')`;
                    petBackgroundBuffDisplay.textContent = `‡πÇ‡∏ö‡∏ô‡∏±‡∏™: ${bgInfo.description}`;
                    petBackgroundBuffDisplay.classList.remove('hidden');
                } else {
                    petDisplayArea.style.backgroundImage = `url('${petBackgroundDefinitions.default.image}')`;
                    petBackgroundBuffDisplay.classList.add('hidden');
                }
                
                renderExplorationStatus();
            }
            
            function addPetExp(amount) {
                const pet = state.pet;
                let finalAmount = amount;
                
                const activeBg = state.pet.activeBackground;
                if (activeBg === 'library' || activeBg === 'coffee_lounge' || activeBg === 'digital_nexus') {
                    if (activeBg === 'library') finalAmount *= 1.1;
                    if (activeBg === 'coffee_lounge') finalAmount *= 1.1;
                    if (activeBg === 'digital_nexus') finalAmount *= 1.15;
                }
                finalAmount = Math.round(finalAmount);

                const maxExp = pet.level * 100;
                pet.exp += finalAmount;

                while (pet.exp >= maxExp) {
                    pet.level++;
                    pet.exp -= maxExp;
                    alert(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ${pet.name} ‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏≠‡∏±‡∏õ‡πÄ‡∏õ‡πá‡∏ô Lv. ${pet.level} ‡πÅ‡∏•‡πâ‡∏ß!`);
                }
                saveState();
                renderPetStats();
            }

            function handleEggTap() {
                eggTaps++;
                eggTapsText.textContent = eggTaps;
                eggImage.classList.add('shaking');
                setTimeout(() => eggImage.classList.remove('shaking'), 200);
                if (eggTaps >= TAPS_TO_HATCH) {
                    eggStage.classList.add('hidden');
                    nameStage.classList.remove('hidden');
                }
            }

            function confirmPetName() {
                const name = petNameInput.value.trim();
                if (name) {
                    state.pet = {
                        exists: true,
                        name: name,
                        level: 1,
                        exp: 0,
                        hunger: 50,
                        happiness: 60,
                        stamina: 100,
                        exploration: null,
                        lastPattedDate: null,
                        lastStatusUpdate: Date.now(),
                        ownedBackgrounds: ['default'],
                        activeBackground: 'default',
                        upgradeLevels: { bed: 0, bowl: 0, toy_shelf: 0 }
                    };
                    saveState();
                    hatchModal.classList.remove('visible');
                    renderFloatingPet();
                } else {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≠‡∏á‡∏°‡πà‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞!');
                }
            }

            function showFeedModal() {
                foodList.innerHTML = '';
                
                let costMultiplier = 1.0;
                if (state.pet.ownedBackgrounds.includes('hidden_shop')) {
                    costMultiplier *= 0.9;
                }
                if (state.pet.upgradeLevels.bowl >= 4) {
                    costMultiplier *= 0.95;
                }
                if (state.pet.activeBackground === 'restaurant') {
                    costMultiplier *= 0.8;
                }

                for (const foodName in petFoodDefinitions) {
                    const food = petFoodDefinitions[foodName];
                    const hasItem = (state.inventory[foodName] || 0) > 0;
                    
                    const bowlLevel = state.pet.upgradeLevels.bowl;
                    const hungerBonus = 1 + ((bowlLevel-1) * 0.05) + (bowlLevel >= 2 ? 0.05 : 0); // Lv2: +5%, Lv3: +10% etc.
                    let finalHungerGain = Math.round(food.hunger * hungerBonus);
                    if (state.pet.activeBackground === 'grand_kitchen') finalHungerGain = Math.round(finalHungerGain * 1.25);

                    const foodEl = document.createElement('button');
                    foodEl.className = 'btn-base w-full flex justify-between items-center p-3 bg-rose-50 rounded-lg border-l-4 border-rose-200';
                    
                    const feedAction = () => {
                        let happinessGain = 0;
                        if (state.pet.activeBackground === 'cute_cafe') happinessGain += 10;
                        if (state.pet.activeBackground === 'crystal_chamber' && foodName === '‡πÄ‡∏Ñ‡πâ‡∏Å') happinessGain += 15;

                        state.pet.hunger = Math.min(100 + (state.pet.upgradeLevels.bowl >= 2 ? 5 : 0), state.pet.hunger + finalHungerGain);
                        state.pet.happiness = Math.min(100 + (state.pet.upgradeLevels.bed >= 2 ? 5 : 0), state.pet.happiness + happinessGain);
                        
                        let expGain = food.exp;
                        if (state.pet.activeBackground === 'mythical_garden' && foodName === '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á') expGain = Math.round(expGain * 1.1);
                        if (state.pet.activeBackground === 'library' && foodName === '‡∏ö‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏•‡∏µ') expGain = Math.round(expGain * 1.2);
                        addPetExp(expGain);
                        
                        // Track Achievement
                        const achievementKeyMap = { '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á': 'feed_bread', '‡πÄ‡∏Ñ‡πâ‡∏Å': 'feed_cake', '‡πÑ‡∏≠‡∏®‡∏Å‡∏£‡∏µ‡∏°': 'feed_icecream', '‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®': 'feed_tomato', '‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó': 'feed_carrot', '‡∏ö‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏•‡∏µ': 'feed_broccoli', '‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ': 'feed_strawberry' };
                        if (achievementKeyMap[foodName]) {
                            trackAchievement(achievementKeyMap[foodName]);
                        }
                        
                        floatingPetImage.src = petEmotions.happy;
                        petModalImageEl.src = petEmotions.happy;
                        setTimeout(renderPetStats, 2000);

                        hideFeedModal();
                        alert(`‡∏Ñ‡∏∏‡∏ì‡∏õ‡πâ‡∏≠‡∏ô ${foodName} ‡πÉ‡∏´‡πâ ${state.pet.name}!`);
                        saveState();
                        renderInventory();
                        renderPetStats();
                    };

                    if (hasItem) {
                        foodEl.innerHTML = `
                            <span>‡πÉ‡∏ä‡πâ ${foodName} (+${finalHungerGain} ‚ù§Ô∏è)</span>
                            <span class="font-bold text-gray-600">‡∏°‡∏µ ${state.inventory[foodName]} ‡∏ä‡∏¥‡πâ‡∏ô</span>
                        `;
                        foodEl.onclick = () => {
                            state.inventory[foodName]--;
                            feedAction();
                        };
                    } else if (food.cost > 0) {
                        const finalCost = Math.round(food.cost * costMultiplier);
                        foodEl.innerHTML = `
                            <span>‡∏ã‡∏∑‡πâ‡∏≠ ${foodName} (+${finalHungerGain} ‚ù§Ô∏è)</span>
                            <span class="font-bold text-amber-600">${finalCost} ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</span>
                        `;
                        foodEl.onclick = () => {
                            if (state.monCoins >= finalCost) {
                                state.monCoins -= finalCost;
                                updateCoinDisplays();
                                feedAction();
                            } else {
                                alert('‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏°‡πà‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏à‡πâ‡∏≤!');
                            }
                        };
                    } else {
                        continue;
                    }
                    foodList.appendChild(foodEl);
                }
                feedModal.classList.add('visible');
            }
            
            function hideFeedModal() {
                feedModal.classList.remove('visible');
            }
            
            function showPlayModal() {
                playOptionsList.innerHTML = '';
                const today = new Date().toDateString();
                const canPat = state.pet.lastPattedDate !== today;

                const patEl = document.createElement('button');
                patEl.className = `btn-base w-full flex justify-between items-center p-3 bg-blue-50 rounded-lg border-l-4 border-blue-200 ${!canPat ? 'opacity-50 cursor-not-allowed' : ''}`;
                patEl.innerHTML = `
                    <span>‡∏•‡∏π‡∏ö‡∏´‡∏±‡∏ß (+15 üòä)</span>
                    <span class="font-bold text-blue-600">‡∏ü‡∏£‡∏µ (‡∏ß‡∏±‡∏ô‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</span>
                `;
                if (canPat) {
                    patEl.onclick = () => handlePlayAction('pat');
                } else {
                    patEl.disabled = true;
                }
                playOptionsList.appendChild(patEl);

                for (const toyName in petToys) {
                    if (state.inventory[toyName] > 0) {
                        const toy = petToys[toyName];
                        let happinessGain = toy.happiness;
                        
                        const toyShelfLevel = state.pet.upgradeLevels.toy_shelf;
                        if (toyShelfLevel >= 2) happinessGain = Math.round(happinessGain * 1.05);
                        if (state.pet.activeBackground === 'playroom') happinessGain = Math.round(happinessGain * 1.2);
                        if (state.pet.activeBackground === 'toy_gallery') happinessGain = Math.round(happinessGain * 1.25);
                        if (state.pet.activeBackground === 'amusement_park') happinessGain = Math.round(happinessGain * 1.2);


                        const toyEl = document.createElement('button');
                        toyEl.className = 'btn-base w-full flex justify-between items-center p-3 bg-blue-50 rounded-lg border-l-4 border-blue-200';
                        toyEl.innerHTML = `
                            <span>‡πÉ‡∏ä‡πâ ${toyName} (+${happinessGain} üòä)</span>
                            <span class="font-bold text-gray-600">‡∏°‡∏µ ${state.inventory[toyName]} ‡∏ä‡∏¥‡πâ‡∏ô</span>
                        `;
                        toyEl.onclick = () => handlePlayAction(toyName, happinessGain);
                        playOptionsList.appendChild(toyEl);
                    }
                }
                playModal.classList.add('visible');
            }
            
            function hidePlayModal() {
                playModal.classList.remove('visible');
            }

            function handlePlayAction(action, happinessGain = 15) {
                let expGain = 0;
                let playCoinGain = 0;
                
                if (action === 'pat') {
                    const today = new Date().toDateString();
                    if (state.pet.lastPattedDate !== today) {
                        state.pet.lastPattedDate = today;
                        expGain = 10;
                        playCoinGain = 1 + Math.floor(state.pet.level / 5);
                        alert(`‡∏Ñ‡∏∏‡∏ì‡∏•‡∏π‡∏ö‡∏´‡∏±‡∏ß ${state.pet.name} ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏≠‡πá‡∏ô‡∏î‡∏π!\n‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${playCoinGain} ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÄ‡∏•‡πà‡∏ô‡∏°‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡∏∞ ${expGain} EXP!`);
                    }
                } 
                else if (petToys[action] && state.inventory[action] > 0) {
                    state.inventory[action]--;
                    expGain = petToys[action].exp;
                    alert(`‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ ${action} ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ö ${state.pet.name}!`);
                    
                    const achievementKeyMap = { '‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏¢‡∏≤‡∏á': 'play_rubber_toy', '‡∏•‡∏π‡∏Å‡∏ö‡∏≠‡∏•': 'play_ball', '‡∏Å‡∏µ‡∏ï‡πâ‡∏≤': 'play_guitar', '‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå': 'play_computer' };
                    if (achievementKeyMap[action]) {
                        trackAchievement(achievementKeyMap[action]);
                    }
                }

                state.pet.happiness = Math.min(100 + (state.pet.upgradeLevels.bed >= 2 ? 5 : 0), state.pet.happiness + happinessGain);
                
                if (state.pet.upgradeLevels.bed >= 4) expGain += 5;
                if (state.pet.activeBackground === 'music_room') expGain = Math.round(expGain * 1.15);
                
                if (expGain > 0) addPetExp(expGain);
                if (playCoinGain > 0) state.playCoins += playCoinGain;

                floatingPetImage.classList.add('pet-happy-animation');
                floatingPetImage.addEventListener('animationend', () => {
                    floatingPetImage.classList.remove('pet-happy-animation');
                }, { once: true });

                saveState();
                renderPetStats();
                renderInventory();
                updateCoinDisplays();
                hidePlayModal();
            }
            
            function showUseItemModal() {
                itemUseList.innerHTML = '';
                let hasStaminaItem = false;

                for (const itemId in staminaItems) {
                    if (state.inventory[itemId] > 0) {
                        hasStaminaItem = true;
                        const itemEffect = staminaItems[itemId];
                        const itemDetails = consumableItems[itemId];

                        const itemEl = document.createElement('button');
                        itemEl.className = 'btn-base w-full flex justify-between items-center p-3 bg-teal-50 rounded-lg border-l-4 border-teal-200';
                        itemEl.innerHTML = `
                            <span>‡πÉ‡∏ä‡πâ ${itemDetails.name} (+${itemEffect.stamina} ‚ö°Ô∏è)</span>
                            <span class="font-bold text-gray-600">‡∏°‡∏µ ${state.inventory[itemId]} ‡∏ä‡∏¥‡πâ‡∏ô</span>
                        `;
                        itemEl.onclick = () => {
                            if (state.pet.stamina >= 100) {
                                alert('‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏à‡πâ‡∏≤!');
                                return;
                            }
                            state.inventory[itemId]--;
                            state.pet.stamina = Math.min(100, state.pet.stamina + itemEffect.stamina);
                            
                            const achievementKeyMap = { 'item_m150': 'use_m150', 'item_latte': 'use_latte', 'item_americano': 'use_americano' };
                            if (achievementKeyMap[itemId]) {
                                trackAchievement(achievementKeyMap[itemId]);
                            }

                            hideUseItemModal();
                            alert(`‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ ${itemDetails.name} ‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô!`);
                            saveState();
                            renderInventory();
                            renderPetStats();
                        };
                        itemUseList.appendChild(itemEl);
                    }
                }
                if (!hasStaminaItem) {
                    itemUseList.innerHTML = `<p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏¢</p>`;
                }
                useItemModal.classList.add('visible');
            }

            function hideUseItemModal() {
                useItemModal.classList.remove('visible');
            }

            function renderUpgradesUI() {
                upgradeList.innerHTML = '';
                const upgrades = [
                    { id: 'bed', name: '‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ô‡∏≠‡∏ô', icon: 'üõèÔ∏è', descriptions: ['+20 EXP', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î +5', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏•‡∏î‡∏ä‡πâ‡∏≤‡∏•‡∏á 5%', '+5 EXP ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢', '‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å "‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà"'] },
                    { id: 'bowl', name: '‡∏ä‡∏≤‡∏°‡∏Ç‡πâ‡∏≤‡∏ß', icon: 'üçö', descriptions: ['+20 EXP', '‡∏≠‡∏¥‡πà‡∏°‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î +5', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏¥‡∏ß‡∏•‡∏î‡∏ä‡πâ‡∏≤‡∏•‡∏á 5%', '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏•‡∏î 5%', '‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å "‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà"'] },
                    { id: 'toy_shelf', name: '‡∏ä‡∏±‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô', icon: 'üß∏', descriptions: ['+20 EXP', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô +5%', '‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏î‡∏£‡∏≠‡∏õ‡∏Ç‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô +3%', '‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÄ‡∏•‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏±‡πâ‡∏ô‡∏•‡∏á', '‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å "‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô"'] }
                ];

                upgrades.forEach(upgrade => {
                    const currentLevel = state.pet.upgradeLevels[upgrade.id];
                    const isMaxLevel = currentLevel >= maxUpgradeLevel;
                    
                    const effectText = currentLevel > 0 ? upgrade.descriptions[currentLevel - 1] : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏ö‡∏ô‡∏±‡∏™';
                    const nextEffectText = isMaxLevel ? '‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß' : `Lv.${currentLevel + 1}: ${upgrade.descriptions[currentLevel]}`;
                    
                    const cost = isMaxLevel ? -1 : upgradeCosts[currentLevel];
                    const canAfford = state.monCoins >= cost;
                    
                    const el = document.createElement('div');
                    el.className = 'bg-gray-100 p-3 rounded-lg';
                    el.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-bold text-lg text-gray-800 flex items-center">${upgrade.icon} ${upgrade.name} (Lv. ${currentLevel})</h4>
                                <p class="text-sm font-semibold text-green-600">‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${effectText}</p>
                            </div>
                            <button data-id="${upgrade.id}" class="upgrade-btn btn-base text-white font-bold py-2 px-4 rounded-lg border-b-4 ${isMaxLevel || !canAfford ? 'bg-gray-400 border-gray-500 cursor-not-allowed' : 'bg-green-500 border-green-700'}">
                                ${isMaxLevel ? 'MAX' : `${cost} $`}
                            </button>
                        </div>
                        <div class="text-center text-xs text-gray-500 mt-2 bg-white p-1 rounded">‡∏ú‡∏•‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ${nextEffectText}</div>
                    `;
                    upgradeList.appendChild(el);
                });

                document.querySelectorAll('.upgrade-btn').forEach(btn => {
                    btn.addEventListener('click', handleUpgrade);
                });
            }
            
            function handleUpgrade(event) {
                const upgradeId = event.target.dataset.id;
                const currentLevel = state.pet.upgradeLevels[upgradeId];

                if (currentLevel >= maxUpgradeLevel) return;

                const cost = upgradeCosts[currentLevel];
                if (state.monCoins >= cost) {
                    state.monCoins -= cost;
                    state.pet.upgradeLevels[upgradeId]++;
                    
                    trackAchievement(`upgrade_${upgradeId}`, state.pet.upgradeLevels[upgradeId]); // Set progress to current level
                    
                    // Check for special all-max achievement
                    if (state.pet.upgradeLevels.bed === 5 && state.pet.upgradeLevels.bowl === 5 && state.pet.upgradeLevels.toy_shelf === 5) {
                        trackAchievement('upgrade_all_max');
                    }

                    saveState();
                    updateCoinDisplays();
                    renderUpgradesUI();
                    alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                } else {
                    alert('‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏°‡πà‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏à‡πâ‡∏≤!');
                }
            }

            function formatCountdown(ms) {
                if (ms < 0) ms = 0;
                let s = Math.floor(ms / 1000);
                let m = Math.floor(s / 60);
                let h = Math.floor(m / 60);
                s %= 60;
                m %= 60;
                return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            }

            function handleExplorationCompletion(locationId) {
                const location = explorationLocations[locationId];
                if (!location) return;

                trackAchievement(`explore_${locationId}`);

                let foundRewards = [];
                let expFromExploration = location.exp;
                
                const activeBg = state.pet.activeBackground;
                if (activeBg === 'ancient_forest') expFromExploration = Math.round(expFromExploration * 1.15);
                addPetExp(expFromExploration);
                foundRewards.push(`${expFromExploration} EXP`);

                let bonusDropChance = 0;
                if (activeBg === 'secret_garden' || activeBg === 'forest') {
                    bonusDropChance = 5;
                }

                location.rewards.forEach(reward => {
                    const roll = Math.random() * 100;
                    if (roll < (reward.chance + bonusDropChance)) {
                         const amountRange = reward.amount ? reward.amount.split('-').map(Number) : [1, 1];
                         const [min, max] = amountRange;
                         const amount = min + Math.floor((max - min + 1) * Math.random());
                         
                         if (reward.type === 'mon_coin') {
                             state.monCoins += amount;
                             foundRewards.push(`${amount} ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏°‡πà‡∏≠‡∏ô`);
                         } else if (reward.type === 'play_coin') {
                             state.playCoins += amount;
                             foundRewards.push(`${amount} ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÄ‡∏•‡πà‡∏ô‡∏°‡πà‡∏≠‡∏ô`);
                         } else if (reward.type === 'item') {
                             const itemName = consumableItems[reward.name]?.name || reward.name;
                             state.inventory[reward.name] = (state.inventory[reward.name] || 0) + 1;
                             foundRewards.push(itemName);
                         } else if (reward.type === 'background') {
                             if (!state.pet.ownedBackgrounds.includes(reward.name)) {
                                 state.pet.ownedBackgrounds.push(reward.name);
                                 const bgName = petBackgroundDefinitions[reward.name]?.name || reward.name;
                                 foundRewards.push(`‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å: ${bgName}`);
                             }
                         }
                    }
                });
                
                let alertMessage = `‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ó‡∏µ‡πà '${location.name}' ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ${state.pet.name} ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß`;
                if (foundRewards.length > 0) {
                    alertMessage += `\n\n${state.pet.name} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:\n- ${foundRewards.join('\n- ')}`;
                } else {
                    alertMessage += `\n‡πÅ‡∏ï‡πà‡∏ô‡πà‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏î‡∏≤‡∏¢‡∏ó‡∏µ‡πà ${state.pet.name} ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢...`;
                }
                alert(alertMessage);

                state.pet.exploration = null;
                saveState();
                updateCoinDisplays();
                renderInventory();
                renderExplorationStatus();
                confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
            }

            function renderExplorationStatus() {
                if (explorationInterval) clearInterval(explorationInterval);

                const exploration = state.pet.exploration;
                const exploreBtnInModal = petActionButtons.querySelector('a[href="exploration.html"]');

                if (exploration) {
                    const locationName = explorationLocations[exploration.locationId].name;
                    explorationStatusCard.classList.remove('hidden');
                    petExplorationStatusInModal.classList.remove('hidden');
                    petExplorationLocationInModal.textContent = locationName;

                    if (exploreBtnInModal) {
                        exploreBtnInModal.classList.add('opacity-50', 'cursor-not-allowed');
                        exploreBtnInModal.style.pointerEvents = 'none';
                    }

                    if (exploration.endTime > Date.now()) {
                        explorationStatusText.innerHTML = `${state.pet.name} ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ó‡∏µ‡πà <strong class="text-pink-500">${locationName}</strong>`;
                        explorationTimerEl.classList.remove('hidden');
                        claimRewardsBtn.classList.add('hidden');

                        const updateTimer = () => {
                            const remaining = exploration.endTime - Date.now();
                            if (remaining <= 0) {
                                renderExplorationStatus();
                            } else {
                                const countdownText = formatCountdown(remaining);
                                explorationTimerEl.textContent = countdownText;
                                petExplorationTimerInModal.textContent = countdownText;
                            }
                        };
                        explorationInterval = setInterval(updateTimer, 1000);
                        updateTimer();
                    } else {
                        explorationStatusText.innerHTML = `${state.pet.name} ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ó‡∏µ‡πà <strong class="text-pink-500">${locationName}</strong> ‡πÅ‡∏•‡πâ‡∏ß!`;
                        explorationTimerEl.classList.add('hidden');
                        claimRewardsBtn.classList.remove('hidden');
                        petExplorationTimerInModal.textContent = "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!";
                    }
                } else {
                    explorationStatusCard.classList.add('hidden');
                    petExplorationStatusInModal.classList.add('hidden');
                    if (exploreBtnInModal) {
                        exploreBtnInModal.classList.remove('opacity-50', 'cursor-not-allowed');
                        exploreBtnInModal.style.pointerEvents = 'auto';
                    }
                }
            }

            function renderPetBackgroundsUI() {
                petBackgroundList.innerHTML = '';
                state.pet.ownedBackgrounds.forEach(bgId => {
                    const bgInfo = petBackgroundDefinitions[bgId];
                    if (!bgInfo) return;

                    const bgEl = document.createElement('div');
                    const isActive = state.pet.activeBackground === bgId;
                    bgEl.className = `cursor-pointer rounded-md p-1 border-2 transition-all ${isActive ? 'border-pink-500 scale-105 shadow-lg' : 'border-transparent'}`;
                    bgEl.innerHTML = `
                        <div class="h-16 bg-cover bg-center rounded" style="background-image: url('${bgInfo.image}')"></div>
                        <p class="text-xs font-semibold mt-1 text-center text-gray-700">${bgInfo.name}</p>
                    `;
                    bgEl.title = bgInfo.description;
                    bgEl.onclick = () => setActiveBackground(bgId);
                    petBackgroundList.appendChild(bgEl);
                });
            }

            function setActiveBackground(bgId) {
                state.pet.activeBackground = bgId;
                saveState();
                renderPetStats();
                backgroundModal.classList.remove('visible');
            }
            
            // --- Achievement System Functions ---
            function trackAchievement(key, value = 1) {
                const isLevelBased = key.startsWith('upgrade_');
                if (isLevelBased) {
                    state.achievementProgress[key] = value;
                } else {
                    state.achievementProgress[key] = (state.achievementProgress[key] || 0) + value;
                }
                updateAchievementNotification();
                saveState();
            }

            function updateAchievementNotification() {
                let hasUnclaimed = false;
                for (const id in achievementDefinitions) {
                    const achievement = achievementDefinitions[id];
                    const progress = state.achievementProgress[id] || 0;
                    for (let i = 0; i < achievement.tiers.length; i++) {
                        const tier = achievement.tiers[i];
                        const statusKey = `${id}_${i}`;
                        if (progress >= tier.goal && !state.achievementStatus[statusKey]) {
                            hasUnclaimed = true;
                            break;
                        }
                    }
                    if (hasUnclaimed) break;
                }
                
                if (hasUnclaimed) {
                    achievementNotification.classList.remove('hidden');
                } else {
                    achievementNotification.classList.add('hidden');
                }
            }
            
            function renderAchievements() {
                achievementsContent.innerHTML = '';
                const achievementsByCategory = {};

                for (const id in achievementDefinitions) {
                    const achievement = achievementDefinitions[id];
                    if (!achievementsByCategory[achievement.category]) {
                        achievementsByCategory[achievement.category] = [];
                    }
                    achievementsByCategory[achievement.category].push({ id, ...achievement });
                }

                for (const category in achievementsByCategory) {
                    const categoryEl = document.createElement('div');
                    categoryEl.innerHTML = `<h3 class="text-lg font-bold text-pink-600 mb-2">${category}</h3>`;
                    
                    achievementsByCategory[category].forEach(ach => {
                        const progress = state.achievementProgress[ach.id] || 0;
                        let nextTier = null;
                        let nextTierIndex = -1;
                        for(let i = 0; i < ach.tiers.length; i++) {
                            const statusKey = `${ach.id}_${i}`;
                            if (!state.achievementStatus[statusKey]) {
                                nextTier = ach.tiers[i];
                                nextTierIndex = i;
                                break;
                            }
                        }

                        const achEl = document.createElement('div');
                        achEl.className = 'bg-white p-3 rounded-lg mb-2 border';
                        
                        let progressText = nextTier ? `${progress} / ${nextTier.goal}` : '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î!';
                        let progressPercent = nextTier ? (progress / nextTier.goal) * 100 : 100;
                        
                        achEl.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-semibold text-gray-800">${ach.icon} ${ach.name}</h4>
                                    <p class="text-xs text-gray-500">${progressText}</p>
                                </div>
                            </div>
                            <div class="progress-bar-bg mt-1">
                                <div class="progress-bar bg-gradient-to-r from-amber-300 to-yellow-400" style="width: ${progressPercent}%;"></div>
                            </div>
                            <div class="mt-2 space-y-1">
                                ${ach.tiers.map((tier, i) => {
                                    const statusKey = `${ach.id}_${i}`;
                                    const isClaimed = state.achievementStatus[statusKey];
                                    const canClaim = progress >= tier.goal && !isClaimed;
                                    
                                    let rewardText = Object.entries(tier.rewards).map(([key, value]) => {
                                        if (key === 'exp') return `+${value} EXP`;
                                        if (key === 'play_coin') return `+${value} ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÄ‡∏•‡πà‡∏ô‡∏°‡πà‡∏≠‡∏ô`;
                                        if (key === 'background') return `‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å "${petBackgroundDefinitions[value]?.name || value}"`;
                                        if (key === 'item') return `+${value.amount} ${consumableItems[value.id]?.name || value.id}`;
                                        return '';
                                    }).join(', ');

                                    let buttonHtml;
                                    if (isClaimed) {
                                        buttonHtml = `<button disabled class="text-xs px-2 py-1 rounded bg-gray-300 text-gray-500">‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</button>`;
                                    } else if (canClaim) {
                                        buttonHtml = `<button data-id="${ach.id}" data-tier="${i}" class="claim-achievement-btn btn-base text-xs px-2 py-1 rounded bg-green-500 text-white font-semibold">‡∏£‡∏±‡∏ö</button>`;
                                    } else {
                                        buttonHtml = `<button disabled class="text-xs px-2 py-1 rounded bg-gray-200 text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á</button>`;
                                    }

                                    return `<div class="flex justify-between items-center text-sm p-1 rounded ${isClaimed ? 'bg-green-50 text-gray-400 line-through' : 'bg-gray-100'}">
                                                <span>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ${tier.goal}: ${rewardText}</span>
                                                ${buttonHtml}
                                            </div>`;
                                }).join('')}
                            </div>
                        `;
                        categoryEl.appendChild(achEl);
                    });
                    achievementsContent.appendChild(categoryEl);
                }

                document.querySelectorAll('.claim-achievement-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        const tierIndex = parseInt(e.target.dataset.tier);
                        claimAchievementReward(id, tierIndex);
                    });
                });
            }

            function claimAchievementReward(id, tierIndex) {
                const achievement = achievementDefinitions[id];
                if (!achievement) return;

                const tier = achievement.tiers[tierIndex];
                const progress = state.achievementProgress[id] || 0;
                const statusKey = `${id}_${tierIndex}`;

                if (progress >= tier.goal && !state.achievementStatus[statusKey]) {
                    state.achievementStatus[statusKey] = true;

                    // Grant rewards
                    if (tier.rewards.exp) addPetExp(tier.rewards.exp);
                    if (tier.rewards.play_coin) state.playCoins += tier.rewards.play_coin;
                    if (tier.rewards.item) {
                        state.inventory[tier.rewards.item.id] = (state.inventory[tier.rewards.item.id] || 0) + tier.rewards.item.amount;
                    }
                    if (tier.rewards.background) {
                        if (!state.pet.ownedBackgrounds.includes(tier.rewards.background)) {
                            state.pet.ownedBackgrounds.push(tier.rewards.background);
                        }
                    }
                    
                    saveState();
                    updateCoinDisplays();
                    renderInventory();
                    renderAchievements(); // Re-render to update button state
                    updateAchievementNotification(); // Check for other notifications
                    alert('‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                }
            }


            // --- Drag and Drop for Floating Pet ---
            let isDragging = false;
            let dragStartX, dragStartY;
            let lastTranslateX = 0, lastTranslateY = 0;

            function dragStart(e) {
                isDragging = false;
                
                if (e.type === 'touchstart') {
                    dragStartX = e.touches[0].clientX;
                    dragStartY = e.touches[0].clientY;
                } else {
                    dragStartX = e.clientX;
                    dragStartY = e.clientY;
                }
                floatingPetContainer.style.transform = `translate(${lastTranslateX}px, ${lastTranslateY}px) scale(1.1)`;
                floatingPetContainer.style.transition = 'none';

                document.addEventListener('mousemove', dragMove);
                document.addEventListener('touchmove', dragMove);
                document.addEventListener('mouseup', dragEnd);
                document.addEventListener('touchend', dragEnd);
            }

            function dragMove(e) {
                isDragging = true;
                e.preventDefault();
                
                let currentX, currentY;
                if (e.type === 'touchmove') {
                    currentX = e.touches[0].clientX;
                    currentY = e.touches[0].clientY;
                } else {
                    currentX = e.clientX;
                    currentY = e.clientY;
                }
                const dx = currentX - dragStartX;
                const dy = currentY - dragStartY;
                floatingPetContainer.style.transform = `translate(${lastTranslateX + dx}px, ${lastTranslateY + dy}px) scale(1.1)`;
            }

            function dragEnd(e) {
                if (isDragging) {
                     let finalX, finalY;
                     if (e.type === 'touchend' && e.changedTouches.length > 0) {
                         finalX = e.changedTouches[0].clientX;
                         finalY = e.changedTouches[0].clientY;
                     } else {
                         finalX = e.clientX;
                         finalY = e.clientY;
                     }
                     lastTranslateX += finalX - dragStartX;
                     lastTranslateY += finalY - dragStartY;
                }
                
                floatingPetContainer.style.transform = `translate(${lastTranslateX}px, ${lastTranslateY}px) scale(1)`;
                floatingPetContainer.style.transition = 'transform 0.2s ease-out';
                
                document.removeEventListener('mousemove', dragMove);
                document.removeEventListener('touchmove', dragMove);
                document.removeEventListener('mouseup', dragEnd);
                document.removeEventListener('touchend', dragEnd);
            }


            // --- Event Listeners ---
            function setupEventListeners() {
                document.getElementById('go-to-shop-btn').addEventListener('click', () => showScreen('shop'));
                document.getElementById('shop-back-btn').addEventListener('click', () => showScreen('menu'));
                
                checkInBtn.addEventListener('click', () => {
                    const today = new Date().toDateString();
                    if (state.lastCheckinDate !== today) {
                        state.playCoins += 5;
                        state.lastCheckinDate = today;
                        updateCoinDisplays();
                        updateCheckInButton();
                        saveState();
                        alert('‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö 5 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÄ‡∏•‡πà‡∏ô‡∏°‡πà‡∏≠‡∏ô');
                        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    }
                });
                
                gachaPullBtn.addEventListener('click', () => {
                    const gachaCost = 50;
                    if (state.monCoins >= gachaCost) {
                        gachaPullBtn.classList.add('shaking');
                        setTimeout(() => gachaPullBtn.classList.remove('shaking'), 820);

                        state.monCoins -= gachaCost;
                        
                        const prize = pullGacha();
                        givePrize(prize);
                        
                        saveState();
                        updateCoinDisplays();
                        renderInventory();
                        
                        showGachaModal(prize);
                    } else {
                        alert('‡∏≠‡∏∏‡πä‡∏¢! ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏°‡πà‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤!');
                    }
                });

                closeGachaModalBtn.addEventListener('click', hideGachaModal);
                gachaModal.addEventListener('click', (e) => { if (e.target === gachaModal) hideGachaModal(); });
                gachaRatesBtn.addEventListener('click', showGachaRatesModal);
                closeGachaRatesModalBtn.addEventListener('click', hideGachaRatesModal);
                gachaRatesModal.addEventListener('click', (e) => { if (e.target === gachaRatesModal) hideGachaRatesModal(); });

                floatingPetContainer.addEventListener('mousedown', dragStart);
                floatingPetContainer.addEventListener('touchstart', dragStart);
                floatingPetContainer.addEventListener('click', () => {
                    if (!isDragging) {
                        renderPetStats();
                        petStatsModal.classList.add('visible');
                    }
                });
                
                closePetStatsModalBtn.addEventListener('click', () => petStatsModal.classList.remove('visible'));
                eggImage.addEventListener('click', handleEggTap);
                confirmNameBtn.addEventListener('click', confirmPetName);
                feedPetBtn.addEventListener('click', showFeedModal);
                closeFeedModalBtn.addEventListener('click', () => feedModal.classList.remove('visible'));
                playWithPetBtn.addEventListener('click', showPlayModal);
                closePlayModalBtn.addEventListener('click', hidePlayModal);
                claimRewardsBtn.addEventListener('click', () => {
                    if (state.pet.exploration) {
                        handleExplorationCompletion(state.pet.exploration.locationId);
                    }
                });

                changeBgBtn.addEventListener('click', () => {
                    renderPetBackgroundsUI();
                    backgroundModal.classList.add('visible');
                });
                closeBackgroundModalBtn.addEventListener('click', () => backgroundModal.classList.remove('visible'));
                
                upgradePetBtn.addEventListener('click', () => {
                    renderUpgradesUI();
                    upgradeModal.classList.add('visible');
                });
                closeUpgradeModalBtn.addEventListener('click', () => upgradeModal.classList.remove('visible'));
                
                useItemBtn.addEventListener('click', showUseItemModal);
                closeUseItemModalBtn.addEventListener('click', hideUseItemModal);

                achievementsBtn.addEventListener('click', () => {
                    renderAchievements();
                    achievementsModal.classList.add('visible');
                });
                closeAchievementsModalBtn.addEventListener('click', () => achievementsModal.classList.remove('visible'));
            }

            // --- Initialization ---
            function init() {
                loadState();
                
                if (!state.pet.exists) {
                    hatchModal.classList.add('visible');
                } else {
                    updatePetStatusOverTime();
                    renderFloatingPet();
                    renderExplorationStatus();
                }

                const today = new Date().toDateString();
                if(state.lastMissionDate !== today) {
                    generateNewMissions();
                    state.lastMissionDate = today;
                    saveState();    
                }
                updateCoinDisplays();
                updateCheckInButton();
                renderMissions();
                renderShopItems();
                renderInventory(); 
                pickDailyBonusGame();
                updateAchievementNotification();
                setupEventListeners();
                showScreen('menu'); 

                document.querySelectorAll('.game-card').forEach(card => {
                    card.addEventListener('click', (event) => {
                        event.preventDefault();
                        const gameId = card.dataset.gameId;
                        let targetUrl = card.href;
                        const isBonusGame = gameId === state.dailyBonusGameId;

                        const gameCost = 0;

                        if (state.playCoins >= gameCost) {
                            state.playCoins -= gameCost;
                            updateCoinDisplays();
                            
                            if (isBonusGame) {
                                targetUrl += '?bonus=true';
                            }
                            saveState();
                            window.location.href = targetUrl;
                        } else {
                            alert('‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÄ‡∏•‡πà‡∏ô‡∏°‡πà‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏à‡πâ‡∏≤! ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞');
                        }
                    });
                });
            }

            init();
        });
    </script>
</body>
</html>

