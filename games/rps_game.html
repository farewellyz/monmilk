<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เป่ายิ้งฉุบ - เกมของม่อน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #fbeafe;
            color: #581c87;
        }
        .app-container {
            background-color: #faf5ff;
            box-shadow: 0 0 40px rgba(168, 85, 247, 0.2);
            border: 2px solid white;
        }
        .choice-btn {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-bottom-width: 6px;
        }
        .choice-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .choice-btn:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .choice-btn:disabled {
            filter: grayscale(80%);
            opacity: 0.6;
            pointer-events: none;
        }
        .choice-display {
            width: 128px;
            height: 128px;
            background-color: #e9d5ff;
            border: 4px solid #c084fc;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .choice-display img {
            width: 80%;
            height: 80%;
            object-fit: contain;
            transition: transform 0.3s ease;
        }
        
        #result-banner {
            transform: scale(0.8);
            opacity: 0;
            transition: all 0.3s ease-in-out;
            pointer-events: none;
        }
        #result-banner.visible {
            transform: scale(1);
            opacity: 1;
        }

        .winner {
            border-color: #4ade80 !important;
            transform: scale(1.1);
            box-shadow: 0 0 20px #4ade80;
        }
        .loser {
            border-color: #f87171 !important;
            opacity: 0.6;
            transform: scale(0.9);
        }
        .display-area {
            transition: background-color 0.2s ease-in-out;
        }
        @keyframes flash-win { 0%, 100% { background-color: #fcf5ff; } 50% { background-color: #dcfce7; } }
        @keyframes flash-lose { 0%, 100% { background-color: #fcf5ff; } 50% { background-color: #fee2e2; } }
        @keyframes flash-draw { 0%, 100% { background-color: #fcf5ff; } 50% { background-color: #f3f4f6; } }
        .flash-win { animation: flash-win 0.6s ease-out; }
        .flash-lose { animation: flash-lose 0.6s ease-out; }
        .flash-draw { animation: flash-draw 0.6s ease-out; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div id="app-container" class="app-container max-w-md mx-auto p-6 rounded-3xl w-full">
        <header class="flex items-center justify-between mb-4">
            <a href="index.html" class="text-3xl text-purple-500 hover:text-purple-600 transition">&larr;</a>
            <h1 id="game-title" class="text-3xl font-bold text-purple-600">เป่ายิ้งฉุบ!</h1>
            <div class="text-right">
                <p class="text-sm font-semibold text-gray-500">ชนะต่อเนื่อง</p>
                <p id="win-streak-display" class="text-2xl font-bold text-amber-500">0</p>
            </div>
        </header>
        
        <div id="display-area" class="bg-white p-4 rounded-2xl shadow-inner">
            <div class="flex justify-around items-center my-6">
                <div class="text-center">
                    <h2 class="text-xl font-bold mb-2">คุณ</h2>
                    <div id="player-choice-display" class="choice-display rounded-full">
                        <span class="text-5xl text-purple-400">?</span>
                    </div>
                </div>
                <div class="text-center">
                    <h2 class="text-xl font-bold mb-2">คอมพิวเตอร์</h2>
                    <div id="computer-choice-display" class="choice-display rounded-full">
                        <span class="text-5xl text-purple-400">?</span>
                    </div>
                </div>
            </div>

            <div id="result-banner" class="text-center my-4 h-16 flex flex-col items-center justify-center">
                <p id="result-message" class="text-4xl font-extrabold"></p>
                <p id="reward-message" class="text-lg font-semibold text-amber-600"></p>
            </div>
        </div>

        <div id="action-area" class="mt-6 text-center">
            <p id="choose-text" class="text-center text-xl font-semibold mb-4 hidden">เลือกอาวุธของคุณ!</p>
            <div id="choices-buttons" class="flex justify-around hidden">
                <button class="choice-btn bg-blue-500 border-blue-700 p-4 rounded-2xl" data-choice="rock">
                    <img src="rock.jpg" alt="ค้อน" class="w-16 h-16">
                </button>
                <button class="choice-btn bg-green-500 border-green-700 p-4 rounded-2xl" data-choice="paper">
                    <img src="paper.jpg" alt="กระดาษ" class="w-16 h-16">
                </button>
                <button class="choice-btn bg-red-500 border-red-700 p-4 rounded-2xl" data-choice="scissors">
                    <img src="scissors.jpg" alt="กรรไกร" class="w-16 h-16">
                </button>
            </div>
            <div id="game-control-area" class="flex justify-center items-center gap-4">
                 <button id="start-game-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg text-xl border-b-4 border-purple-800 transition">เริ่มเกม (ใช้ 1 เหรียญเล่นม่อน)</button>
                 <button id="play-again-btn" class="hidden bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg text-xl border-b-4 border-purple-700 transition">เล่นตาต่อไป (ฟรี)</button>
                 <a href="index.html" id="back-to-menu-btn" class="hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg text-xl border-b-4 border-gray-700 transition">กลับหน้าหลัก</a>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let state = {};
            const choices = ['rock', 'paper', 'scissors'];
            
            const displayArea = document.getElementById('display-area');
            const playerChoiceDisplay = document.getElementById('player-choice-display');
            const computerChoiceDisplay = document.getElementById('computer-choice-display');
            const resultBanner = document.getElementById('result-banner');
            const resultMessage = document.getElementById('result-message');
            const rewardMessage = document.getElementById('reward-message');
            const choicesButtons = document.getElementById('choices-buttons');
            const chooseText = document.getElementById('choose-text');
            const gameControlArea = document.getElementById('game-control-area');
            const startGameBtn = document.getElementById('start-game-btn');
            const playAgainBtn = document.getElementById('play-again-btn');
            const backToMenuBtn = document.getElementById('back-to-menu-btn');
            const winStreakDisplay = document.getElementById('win-streak-display');
            const gameTitle = document.getElementById('game-title');
            
            let canPlay = false;
            let winStreak = 0;
            let isCurrentGameBonus = false;

            function saveState() { localStorage.setItem('monGameDataV17', JSON.stringify(state)); }
            function loadState() {
                const savedData = localStorage.getItem('monGameDataV17');
                state = savedData ? JSON.parse(savedData) : { monCoins: 0, playCoins: 0 };
            }

            function getComputerChoice() {
                return choices[Math.floor(Math.random() * choices.length)];
            }
            
            function updateChoiceDisplay(element, choice) {
                if(choice === '?') {
                    element.innerHTML = `<span class="text-5xl text-purple-400">?</span>`;
                } else {
                    element.innerHTML = `<img src="${choice}.jpg" alt="${choice}">`;
                }
            }

            function playGame(playerChoice) {
                if (!canPlay) return;
                canPlay = false;

                const computerChoice = getComputerChoice();
                
                updateChoiceDisplay(playerChoiceDisplay, playerChoice);
                updateChoiceDisplay(computerChoiceDisplay, computerChoice);
                
                const result = determineWinner(playerChoice, computerChoice);
                displayResult(result);
            }

            function determineWinner(player, computer) {
                if (player === computer) return 'draw';
                if (
                    (player === 'rock' && computer === 'scissors') ||
                    (player === 'paper' && computer === 'rock') ||
                    (player === 'scissors' && computer === 'paper')
                ) {
                    return 'win';
                }
                return 'lose';
            }

            function displayResult(result) {
                let reward = 0;
                let rewardText = '';
                
                choicesButtons.classList.add('hidden');
                chooseText.classList.add('hidden');

                if (result === 'win' || result === 'draw') {
                    playAgainBtn.classList.remove('hidden');
                    backToMenuBtn.classList.add('hidden');
                    startGameBtn.classList.add('hidden');

                    if (result === 'win') {
                        winStreak++;
                        reward = Math.pow(2, winStreak - 1);
                        resultMessage.innerHTML = '✔ คุณชนะ!';
                        resultMessage.className = 'text-4xl font-extrabold text-green-500';
                        playerChoiceDisplay.classList.add('winner');
                        computerChoiceDisplay.classList.add('loser');
                        displayArea.className = "bg-white p-4 rounded-2xl shadow-inner flash-win";
                        
                        if (isCurrentGameBonus) {
                            reward *= 2;
                            rewardText = `ได้รับ ${reward} เหรียญ (โบนัส x2!)`;
                        } else {
                            rewardText = `ได้รับ ${reward} เหรียญ`;
                        }
                    } else { // Draw
                        resultMessage.textContent = 'เสมอ!';
                        resultMessage.className = 'text-4xl font-extrabold text-gray-500';
                        displayArea.className = "bg-white p-4 rounded-2xl shadow-inner flash-draw";
                        rewardText = `ชนะต่อเนื่อง ${winStreak} ครั้ง`;
                    }
                } else { // Lose
                    winStreak = 0;
                    resultMessage.innerHTML = '✖ คุณแพ้แล้ว!';
                    resultMessage.className = 'text-4xl font-extrabold text-red-500';
                    playerChoiceDisplay.classList.add('loser');
                    computerChoiceDisplay.classList.add('winner');
                    playAgainBtn.classList.remove('hidden'); // << แสดงปุ่ม "เล่นอีกครั้ง"
                    playAgainBtn.textContent = "เล่นอีกครั้ง (ใช้ 1 เหรียญเล่นม่อน)"; // << เปลี่ยนข้อความ
                    backToMenuBtn.classList.remove('hidden'); // << แสดงปุ่ม "กลับหน้าหลัก"
                    startGameBtn.classList.add('hidden');
                    displayArea.className = "bg-white p-4 rounded-2xl shadow-inner flash-lose";
                    rewardText = 'ชนะต่อเนื่องถูกรีเซ็ต!';
                }
                
                if (reward > 0) {
                    state.monCoins += reward;
                    saveState();
                }
                
                winStreakDisplay.textContent = winStreak;
                rewardMessage.textContent = rewardText;
                resultBanner.classList.add('visible');

                setTimeout(() => {
                    displayArea.className = "bg-white p-4 rounded-2xl shadow-inner";
                }, 600);
            }

            function resetForNewRound() {
                canPlay = true;
                resultBanner.classList.remove('visible');
                playAgainBtn.classList.add('hidden');
                startGameBtn.classList.add('hidden');
                backToMenuBtn.classList.add('hidden');
                choicesButtons.classList.remove('hidden');
                chooseText.classList.remove('hidden');
                updateChoiceDisplay(playerChoiceDisplay, '?');
                updateChoiceDisplay(computerChoiceDisplay, '?');
                playerChoiceDisplay.classList.remove('winner', 'loser');
                computerChoiceDisplay.classList.remove('winner', 'loser');
                rewardMessage.textContent = '';
            }
            
            function handleStartGame() {
                loadState();
                const cost = 1;
                if (state.playCoins >= cost) {
                    state.playCoins -= cost;
                    saveState();
                    
                    // BUG FIX: ซ่อนปุ่มที่ไม่เกี่ยวข้องเมื่อเริ่มเกมใหม่
                    startGameBtn.classList.add('hidden');
                    backToMenuBtn.classList.add('hidden'); 
                    playAgainBtn.textContent = "เล่นตาต่อไป (ฟรี)"; // รีเซ็ตข้อความปุ่ม
                    
                    resetForNewRound();
                } else {
                    alert('เหรียญเล่นม่อนไม่พอ!');
                }
            }

            // --- Event Listeners ---
            choicesButtons.addEventListener('click', (event) => {
                const choice = event.target.closest('button')?.dataset.choice;
                if (choice) {
                    playGame(choice);
                }
            });
            
            // --- แก้ไข: ปุ่ม Play Again ตอนนี้มี 2 หน้าที่ ---
            playAgainBtn.addEventListener('click', () => {
                // ถ้าปุ่มมีข้อความว่าต้องจ่ายเงิน (คือเพิ่งแพ้มา) ให้เรียก handleStartGame
                if (playAgainBtn.textContent.includes('เหรียญเล่นม่อน')) {
                    handleStartGame();
                } else {
                    // ถ้าไม่ (คือเพิ่งชนะ/เสมอ) ให้เริ่มรอบใหม่ฟรี
                    resetForNewRound();
                }
            });

            startGameBtn.addEventListener('click', handleStartGame);

            // --- Initialization ---
            function init() {
                loadState();
                const urlParams = new URLSearchParams(window.location.search);
                isCurrentGameBonus = urlParams.get('bonus') === 'true';
                if(isCurrentGameBonus) {
                    gameTitle.innerHTML = "เป่ายิ้งฉุบ <span class='text-yellow-300'>(โบนัส x2!)</span>";
                }
                winStreakDisplay.textContent = winStreak;
            }

            init();
        });
    </script>
</body>
</html>
