<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สวนผักของฉัน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Kanit', sans-serif; 
            background-color: #a7d9b5;
            background-image: url('garden_background.gif');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            position: relative;
        }
        body::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(167, 217, 181, 0.4);
            z-index: -1;
        }
        .app-container {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 2rem;
            border: 10px solid #8B4513;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3), inset 0 0 25px rgba(0,0,0,0.15);
            max-width: 500px;
            width: 100%;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .header-image {
            width: 100%;
            height: 120px;
            background-image: url('garden_header.png');
            background-size: cover;
            background-position: center;
            border-radius: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 3px solid #6D4C41;
        }
        .card-base {
            border: 3px solid #a1887f;
            background-color: #fffef0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-radius: 1.5rem;
            padding: 1.5rem;
        }
        .btn-base {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.25rem;
            font-weight: 600;
            border-radius: 0.75rem;
            transition: transform 0.2s ease, filter 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            border-bottom: 4px solid;
            background-image: linear-gradient(to bottom, #f9f9e0, #e0e0c0);
            color: #4A4A4A;
        }
        .btn-base:hover { 
            transform: translateY(-2px); 
            filter: brightness(1.05);
            box-shadow: 0 5px 12px rgba(0,0,0,0.3);
        }
        .btn-base:active {
            transform: translateY(1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .btn-primary {
            background-image: linear-gradient(to bottom, #8BC34A, #689F38);
            border-color: #558B2F;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .btn-secondary {
            background-image: linear-gradient(to bottom, #FFD54F, #FFB300);
            border-color: #FF8F00;
            color: #6D4C41;
            text-shadow: 1px 1px 1px rgba(255,255,255,0.3);
        }
        .btn-cancel {
            background-image: linear-gradient(to bottom, #BDBDBD, #757575);
            border-color: #616161;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .plot {
            background-color: #6D4C41;
            background-image: url('soil_texture.png');
            background-size: cover;
            border: 4px solid #8B4513;
            border-radius: 1.25rem;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.4), 0 5px 15px rgba(0,0,0,0.1);
        }
        .plot:hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow: inset 0 0 15px rgba(0,0,0,0.5), 0 8px 20px rgba(0,0,0,0.2);
        }
        .plot.planted {
             background-image: url('planted_soil_texture.png'); 
             background-size: cover;
        }
        .plot.needs-water {
            background-color: #A0522D;
            background-image: url('dry_soil_texture.png');
            color: #8B4513;
        }
        .plot .plot-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            padding: 4px; /* Add some padding */
        }
        .plot .plot-icon {
            /* --- UI FIX: Responsive Icon Size --- */
            font-size: clamp(2rem, 12vw, 3.5rem); 
            line-height: 1;
            margin-bottom: 0.25rem;
            animation: growIn 0.5s ease-out;
        }
        .plot .plot-text {
            /* --- UI FIX: Responsive Text Size --- */
            font-size: clamp(0.75rem, 4vw, 1rem);
            font-weight: 600;
            text-align: center;
        }
        .plot.needs-water .plot-icon {
            font-size: clamp(2.5rem, 15vw, 4rem);
            color: #4CAF50;
            animation: pulseWater 1.5s infinite ease-in-out;
        }
        .plot.ready .plot-icon {
            animation: bounceHarvest 0.8s infinite ease-in-out;
            color: #FFEB3B;
            text-shadow: 0 0 10px rgba(255,235,59,0.7);
        }
        @keyframes growIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        @keyframes pulseWater {
            0% { transform: scale(0.9); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(0.9); opacity: 0.7; }
        }
        @keyframes bounceHarvest {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .plot-timer {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 3px 12px;
            border-radius: 99px;
            font-size: 0.85rem;
            font-weight: bold;
            border: 2px solid rgba(255,255,255,0.8);
            white-space: nowrap;
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: #fff8e1;
            padding: 2rem; border-radius: 1.5rem;
            text-align: center; width: 90%; max-width: 420px;
            transform: scale(0.9); transition: transform 0.3s ease;
            border: 5px solid #A1887F;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-content h2 {
            color: #6D4C41;
            margin-bottom: 1.5rem;
        }
        .item-list-option {
            background-color: #F5F5DC;
            border: 2px solid #D7CCC8;
            border-left: 6px solid #8BC34A;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            color: #5D4037;
            transition: all 0.2s;
        }
        .item-list-option:hover {
            transform: translateX(5px);
            background-color: #E6E6CC;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="p-4">
    <div class="app-container">
        <header class="relative text-center mb-4">
            <a href="index.html" class="text-3xl text-green-800 hover:text-green-900 transition absolute left-0 top-1/2 -translate-y-1/2 z-10">&larr;</a>
            <div class="header-image"></div> <h1 class="text-4xl font-bold text-lime-800 [text-shadow:2px_2px_4px_rgba(255,255,255,0.8)] mt-2">
                สวนผักของฉัน
            </h1>
        </header>

        <div class="card-base">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-lime-800">แปลงผัก</h2>
                <span id="plot-count" class="font-bold text-gray-600"></span>
            </div>
            <div id="plots-grid" class="grid grid-cols-3 gap-4 mb-4">
                </div>
            <div id="garden-actions">
                </div>
        </div>

        <div class="card-base">
            <h2 class="text-2xl font-semibold text-lime-800 mb-4 text-center">เมล็ดพันธุ์/ไอเทมสวน</h2>
            <div id="seeds-inventory" class="space-y-2">
                <p class="text-center text-gray-500">ไม่มีเมล็ดพันธุ์หรือไอเทมสวนเลย!</p>
            </div>
        </div>
    </div>

    <div id="plant-seed-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-lime-700 mb-4">เลือกเมล็ดพันธุ์</h2>
            <div id="seed-options-list" class="space-y-3"></div>
            <button id="close-plant-seed-modal-btn" class="btn-base btn-cancel w-full mt-6">ยกเลิก</button>
        </div>
    </div>
    
    <div id="plot-actions-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-lime-700 mb-4">ดูแลแปลงผัก</h2>
            <div id="plot-actions-list" class="space-y-3"></div>
            <button id="close-plot-actions-modal-btn" class="btn-base btn-cancel w-full mt-6">ปิด</button>
        </div>
    </div>

    <script src="pet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let state = {};
            let petSystem = null; 
            let gardenInterval = null;
            const WATERING_INTERVAL = 24 * 60 * 60 * 1000;
            const MAX_PLOTS = 12;

            const seedData = {
                'เมล็ดมะเขือเทศ': { growTime: 60 * 60 * 1000, result: 'มะเขือเทศ', plantIcon: '🌿', readyIcon: '🍅', exp: 2 },
                'เมล็ดแครอท': { growTime: 4 * 60 * 60 * 1000, result: 'แครอท', plantIcon: '🥕🌱', readyIcon: '🥕', exp: 3 },
                'เมล็ดบรอกโคลี': { growTime: 8 * 60 * 60 * 1000, result: 'บรอกโคลี', plantIcon: '🥦🌱', readyIcon: '🥦', exp: 4 },
                'เมล็ดสตรอว์เบอร์รี': { growTime: 24 * 60 * 60 * 1000, result: 'สตรอว์เบอร์รี', plantIcon: '🍓🌱', readyIcon: '🍓', exp: 5 },
            };
            
            const fertilizerData = {
                'ปุ๋ยเร่งโต': { timeReduction: 60 * 60 * 1000 } 
            };
            
            // --- BUG FIX & UI FIX ---
            // โค้ดส่วนที่เหลือจะถูกนำมาใส่ที่นี่
            const plantSeedModal = document.getElementById('plant-seed-modal');
            const seedOptionsList = document.getElementById('seed-options-list');
            const closePlantSeedModalBtn = document.getElementById('close-plant-seed-modal-btn');
            const plotActionsModal = document.getElementById('plot-actions-modal');
            const plotActionsList = document.getElementById('plot-actions-list');
            const closePlotActionsModalBtn = document.getElementById('close-plot-actions-modal-btn');

            function loadState() {
                const savedData = localStorage.getItem('monGameDataV17');
                if (savedData) {
                    state = JSON.parse(savedData);
                    if (!state.garden) {
                        state.garden = { plots: Array(6).fill(null) }; 
                    }
                } else {
                    window.location.href = 'index.html'; 
                }
            }

            function saveState() {
                localStorage.setItem('monGameDataV17', JSON.stringify(state));
            }
            
            function formatTime(ms) {
                if (ms < 0) ms = 0;
                let s = Math.floor(ms / 1000);
                let m = Math.floor(s / 60);
                let h = Math.floor(m / 60);
                s %= 60; m %= 60;
                if (h > 0) return `${h} ชม. ${m} นาที`;
                if (m > 0) return `${m} นาที`;
                return `${s} วินาที`;
            }

            function formatCountdown(ms) {
                if (ms < 0) ms = 0;
                let s = Math.floor(ms / 1000);
                let m = Math.floor(s / 60);
                let h = Math.floor(m / 60);
                s %= 60; m %= 60;
                return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            }

            function renderAll() {
                renderPlots();
                renderSeedsInventory();
                renderGardenActions();
            }

            function renderPlots() {
                const plotsGrid = document.getElementById('plots-grid');
                plotsGrid.innerHTML = '';
                if (gardenInterval) clearInterval(gardenInterval);

                state.garden.plots.forEach((plot, index) => {
                    const plotEl = document.createElement('div');
                    plotEl.className = 'plot';
                    
                    if (plot) {
                        const needsWater = Date.now() - plot.lastWatered > WATERING_INTERVAL;
                        const remainingTime = plot.plantTime + plot.effectiveGrowTime - Date.now();
                        
                        const basePlantIcon = seedData[plot.seedName].plantIcon;
                        const currentPlantIcon = plot.isFertilized ? '✨' + basePlantIcon : basePlantIcon;

                        if (remainingTime > 0) {
                            if (needsWater) {
                                plotEl.classList.add('needs-water');
                                plotEl.innerHTML = `
                                    <div class="plot-content">
                                        <div class="plot-icon">💧</div>
                                        <span class="plot-text">ดินแห้ง! รดน้ำเลย</span>
                                    </div>
                                `;
                                plotEl.onclick = () => waterPlot(index);
                            } else {
                                plotEl.classList.add('planted');
                                plotEl.innerHTML = `
                                    <div class="plot-content">
                                        <div class="plot-icon">${currentPlantIcon}</div>
                                    </div>
                                    <div class="plot-timer" id="timer-${index}">${formatCountdown(remainingTime)}</div>
                                `;
                                plotEl.onclick = () => showPlotActionsModal(index);
                            }
                        } else {
                            plotEl.classList.add('ready');
                            plotEl.innerHTML = `
                                <div class="plot-content">
                                    <div class="plot-icon">${seedData[plot.seedName].readyIcon}</div>
                                    <span class="plot-text">เก็บเกี่ยวได้แล้ว!</span>
                                </div>
                            `;
                            plotEl.onclick = () => harvest(index);
                        }
                    } else {
                        plotEl.innerHTML = `
                            <div class="plot-content text-gray-500 opacity-60">
                                <span class="plot-icon">+</span>
                                <span class="plot-text">ปลูก</span>
                            </div>
                        `;
                        plotEl.onclick = () => showPlantSeedModal(index);
                    }
                    plotsGrid.appendChild(plotEl);
                });

                document.getElementById('plot-count').textContent = `${state.garden.plots.length}/${MAX_PLOTS} แปลง`;
                gardenInterval = setInterval(updateTimers, 1000);
            }

            function updateTimers() {
                let needsRender = false;
                state.garden.plots.forEach((plot) => {
                    if (plot && !plot.isPaused) {
                        if (Date.now() - plot.plantTime >= plot.effectiveGrowTime) {
                            needsRender = true;
                        }
                        if (Date.now() - plot.lastWatered > WATERING_INTERVAL) {
                            plot.isPaused = true;
                            plot.pauseTime = Date.now();
                            needsRender = true;
                        }
                    }
                });
                if (needsRender) renderPlots();
                else { // Update timers text content if no re-render is needed
                    state.garden.plots.forEach((plot, index) => {
                         if (plot && !plot.isPaused) {
                            const timerEl = document.getElementById(`timer-${index}`);
                            if(timerEl) {
                                const remainingTime = plot.plantTime + plot.effectiveGrowTime - Date.now();
                                timerEl.textContent = formatCountdown(remainingTime);
                            }
                         }
                    });
                }
            }
            
            function renderGardenActions() {
                const container = document.getElementById('garden-actions');
                container.innerHTML = '';
                if (state.garden.plots.length < MAX_PLOTS) {
                    const currentCost = 50 * Math.pow(2, state.garden.plots.length - 6); 
                    const button = document.createElement('button');
                    button.className = 'btn-base btn-secondary w-full';
                    button.innerHTML = `ซื้อแปลงผักเพิ่ม (${currentCost} <img src="mon_coin_icon.png" class="w-5 h-5 ml-1 inline-block" onerror="this.src='placeholder_coin.png'">)`;
                    button.onclick = () => buyPlot(currentCost);
                    container.appendChild(button);
                }
            }

            function buyPlot(cost) {
                if (state.monCoins >= cost) {
                    if (confirm(`คุณต้องการซื้อแปลงผักใหม่ในราคา ${cost} เหรียญหรือไม่?`)) {
                        state.monCoins -= cost;
                        state.garden.plots.push(null);
                        saveState();
                        renderAll();
                        alert('ซื้อแปลงผักสำเร็จ!');
                    }
                } else {
                    alert('เหรียญม่อนไม่พอจ้า!');
                }
            }

            function renderSeedsInventory() {
                const seedsInventory = document.getElementById('seeds-inventory');
                seedsInventory.innerHTML = '';
                const ownedItems = Object.keys(state.inventory).filter(item => (seedData[item] || fertilizerData[item]) && state.inventory[item] > 0);

                if (ownedItems.length > 0) {
                    ownedItems.sort((a, b) => (seedData[a] ? 0 : 1) - (seedData[b] ? 0 : 1) || a.localeCompare(b));
                    ownedItems.forEach(itemName => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'flex justify-between items-center bg-lime-50 p-3 rounded-lg border border-lime-200 shadow-sm';
                        itemEl.innerHTML = `
                            <span class="font-semibold text-gray-700">${itemName}</span>
                            <span class="font-bold text-lime-600">x${state.inventory[itemName]}</span>
                        `;
                        seedsInventory.appendChild(itemEl);
                    });
                } else {
                    seedsInventory.innerHTML = '<p class="text-center text-gray-500">ไม่มีเมล็ดพันธุ์หรือไอเทมสวนเลย!</p>';
                }
            }

            function showPlantSeedModal(plotIndex) {
                seedOptionsList.innerHTML = '';
                const ownedSeeds = Object.keys(state.inventory).filter(item => seedData[item] && state.inventory[item] > 0);
                if (ownedSeeds.length === 0) {
                    alert('คุณไม่มีเมล็ดพันธุ์สำหรับปลูกเลย!');
                    return;
                }
                ownedSeeds.forEach(seedName => {
                    const seed = seedData[seedName];
                    const optionEl = document.createElement('button');
                    optionEl.className = 'item-list-option';
                    optionEl.innerHTML = `
                        <span>${seedName} <span class="text-xs text-gray-500">(${formatTime(seed.growTime)})</span></span>
                        <span class="font-bold text-green-700">มี ${state.inventory[seedName]}</span>
                    `;
                    optionEl.onclick = () => plantSeed(plotIndex, seedName);
                    seedOptionsList.appendChild(optionEl);
                });
                plantSeedModal.classList.add('visible');
            }
            
            function showPlotActionsModal(plotIndex) {
                plotActionsList.innerHTML = '';
                const plot = state.garden.plots[plotIndex];
                if (!plot) return;
                
                let canDoAction = false;
                if (!plot.isFertilized && state.inventory['ปุ๋ยเร่งโต'] > 0) {
                    canDoAction = true;
                    const fertilizerName = 'ปุ๋ยเร่งโต';
                    const optionEl = document.createElement('button');
                    optionEl.className = 'item-list-option';
                    optionEl.innerHTML = `
                        <span>ใช้ ${fertilizerName} <span class="text-xs text-gray-500">(ลดเวลา 1 ชม.)</span></span>
                        <span class="font-bold text-green-700">มี ${state.inventory[fertilizerName]}</span>
                    `;
                    optionEl.onclick = () => useFertilizer(plotIndex, fertilizerName);
                    plotActionsList.appendChild(optionEl);
                }

                if (!canDoAction) {
                    plotActionsList.innerHTML = '<p class="text-center text-gray-500">ไม่มีไอเทมสำหรับใช้งาน</p>';
                }
                plotActionsModal.classList.add('visible');
            }
            
            function useFertilizer(plotIndex, fertilizerName) {
                const plot = state.garden.plots[plotIndex];
                if (!plot || plot.isFertilized || !(state.inventory[fertilizerName] > 0)) return;
                state.inventory[fertilizerName]--;
                plot.plantTime += fertilizerData[fertilizerName].timeReduction;
                plot.isFertilized = true;
                alert('ใช้ปุ๋ยสำเร็จ! พืชจะโตไวขึ้น 1 ชั่วโมง!');
                saveState();
                renderAll();
                plotActionsModal.classList.remove('visible');
            }

            function plantSeed(plotIndex, seedName) {
                if (state.inventory[seedName] > 0) {
                    state.inventory[seedName]--;
                    
                    const buffs = petSystem.getActiveBuffs();
                    let growTime = seedData[seedName].growTime;
                    
                    // Apply garden speed buffs if they exist in the pet system
                    if (buffs.garden_speed) {
                        growTime *= buffs.garden_speed;
                    }
                    
                    state.garden.plots[plotIndex] = {
                        seedName: seedName,
                        plantTime: Date.now(),
                        lastWatered: Date.now(),
                        effectiveGrowTime: growTime,
                        isFertilized: false,
                        isPaused: false,
                        pauseTime: 0
                    };
                    saveState();
                    renderAll();
                    hidePlantSeedModal();
                } else {
                    alert('เมล็ดพันธุ์ไม่พอ!');
                }
            }
            
            function waterPlot(plotIndex) {
                const plot = state.garden.plots[plotIndex];
                if (plot && plot.isPaused) {
                    const pauseDuration = Date.now() - plot.pauseTime;
                    plot.plantTime += pauseDuration;
                    plot.lastWatered = Date.now();
                    plot.isPaused = false;
                    plot.pauseTime = 0;
                    saveState();
                    renderPlots();
                    alert('รดน้ำแปลงผักแล้ว พืชกลับมาเติบโตต่อ!');
                }
            }

            function harvest(plotIndex) {
                const plot = state.garden.plots[plotIndex];
                if (plot && (Date.now() - plot.plantTime >= plot.effectiveGrowTime)) {
                    const buffs = petSystem.getActiveBuffs();
                    const seed = seedData[plot.seedName];
                    let yieldAmount = 1;

                    if (buffs.bonus_yield_chance && Math.random() < buffs.bonus_yield_chance) {
                        yieldAmount++;
                        alert('โชคดี! ได้ผลผลิตเพิ่ม 1 ชิ้นจากสกิลนักเก็บเกี่ยว!');
                    }

                    const resultItemName = seed.result;
                    state.inventory[resultItemName] = (state.inventory[resultItemName] || 0) + yieldAmount;
                    
                    const baseHarvestExp = seed.exp;
                    petSystem.addPetExp(baseHarvestExp); 
                    
                    let qualityMessage = '';
                    if (buffs.quality_vegetable_chance && Math.random() < buffs.quality_vegetable_chance) {
                        const qualityItemName = `ผักคุณภาพดี (${resultItemName})`;
                        state.inventory[qualityItemName] = (state.inventory[qualityItemName] || 0) + 1;
                        qualityMessage = `\nพิเศษ! คุณได้รับ "${qualityItemName}"!`;
                    }
                    
                    state.garden.plots[plotIndex] = null;
                    
                    alert(`เก็บเกี่ยว ${resultItemName} x${yieldAmount} ได้สำเร็จ! ได้รับ ${baseHarvestExp} EXP!${qualityMessage}`);
                    saveState();
                    renderAll();
                }
            }

            function hidePlantSeedModal() { plantSeedModal.classList.remove('visible'); }

            function init() {
                loadState();

                // --- BUG FIX: Use the full PetSystem to enable addPetExp ---
                petSystem = PetSystem(state, {
                    saveState: saveState,
                    // Provide dummy functions for unused helpers to prevent errors
                    updateCoinDisplays: () => {},
                    renderInventory: () => {},
                    consumableItems: {}
                });

                closePlantSeedModalBtn.addEventListener('click', hidePlantSeedModal);
                closePlotActionsModalBtn.addEventListener('click', () => plotActionsModal.classList.remove('visible'));
                renderAll();
                
            }

            init();
        });
    </script>
    </body>
</html>